<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸš€ BREAKTHROUGH Monitor</title>
  <style>
    body { background:#0d1117; color:#eee; font-family:Inter,Arial,sans-serif; margin:0; }
    header { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; background:#161b22; }
    h1 { font-size:20px; margin:0; }
    select,input,button { background:#21262d; color:#eee; border:1px solid #30363d; border-radius:6px; padding:4px 8px; }
    button.ghost { background:none; border:none; color:#58a6ff; cursor:pointer; }
    .controls { display:flex; gap:10px; align-items:center; }
    .grid { display:flex; flex-direction:column; gap:12px; padding:12px; }
    .row { display:grid; grid-template-columns:220px 1fr 1fr; gap:12px; background:#161b22; border-radius:8px; padding:8px; }
    .cell { background:#0d1117; border-radius:6px; padding:6px; overflow:hidden; }
    .ticker { font-size:18px; font-weight:600; }
    .name { font-size:13px; color:#aaa; }
    .chips { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
    .chip { background:#30363d; border-radius:12px; padding:2px 6px; font-size:12px; }
    iframe { width:100%; height:340px; border:0; transform:scale(0.95); transform-origin:top; }
    .metrics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 12px;font-size:12px;color:#aaa;margin-top:6px}
    .metrics b{color:#eee;font-weight:700}
    #gauge { width:200px; height:100px; position:relative; margin:auto; }
    #needle { width:2px; height:90px; background:red; position:absolute; bottom:0; left:50%; transform-origin:bottom center; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸš€ BREAKTHROUGH Monitor</h1>
    <div class="controls">
      <label>Geo <select id="geo"><option value="US">US</option><option value="">Worldwide</option></select></label>
      <label>Trends <select id="trendTime"><option value="today 1-m">Past 30d</option><option value="today 3-m">3M</option><option value="today 12-m">12M</option></select></label>
      <label>Charts <select id="range"><option value="1M">1M</option><option value="3M">3M</option><option value="6M">6M</option><option value="12M" selected>12M</option><option value="ALL">ALL</option></select></label>
      <input id="add" placeholder="Add ticker e.g. PLTR" /> <button id="addBtn">Add</button>
    </div>
    <div id="gauge">
      <div id="needle"></div>
      <div id="fngVal" style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:14px;"></div>
      <div id="fngSrc" style="position:absolute;top:0;left:50%;transform:translateX(-50%);font-size:11px;color:#aaa;"></div>
    </div>
  </header>

  <div id="table" class="grid"></div>

<script type="module">
  const WATCHLIST=[
    { ticker:'PLTR', name:'Palantir', exchange:'NYSE', trendsQuery:'Palantir' },
    { ticker:'QSI', name:'Quantum-Si', exchange:'NASDAQ', trendsQuery:'Quantum-Si' },
    { ticker:'APLD', name:'Applied Digital', exchange:'NASDAQ', trendsQuery:'Applied Digital' }
  ];

const state = { rows:[], range:'12M', geo:'US', trendTime:'today 1-m' };
const table = document.getElementById('table');
const API_BASE = "https://raspy-bush-72eb.ramanauskas-j.workers.dev/"; // <- replace

  const fngVal=document.getElementById('fngVal');
  const needle=document.getElementById('needle');
  const fngSrc=document.getElementById('fngSrc');

  function setFNG(v,src){
    needle.style.transform=`rotate(${ -90 + (v*1.8) }deg)`;
    fngVal.textContent=v;
    fngSrc.textContent=src||'';
  }

  (async()=>{ const live=await fetchFearGreed(); if(live){ setFNG(live.value, live.source); } })();

  function tvMiniConfig(ticker){ return { symbol:ticker, width:'100%', height:300, locale:'en', dateRange:state.range, colorTheme:'dark', isTransparent:true, autosize:true }; }
  function safeJSON(obj){ return JSON.stringify(obj).replace(/</g,'\\u003c').replace(/>/g,'\\u003e'); }

  function trendSrc(query){
    const req={ comparisonItem:[{ keyword: query, geo: state.geo, time: state.trendTime }], category:0 };
    const tz=-new Date().getTimezoneOffset();
    const base='https://trends.google.com/trends/embed/explore/TIMESERIES';
    const params=new URLSearchParams({ hl:'en-US', req: JSON.stringify(req), tz: String(tz) });
    return `${base}?${params.toString()}`;
  }

  function makeRow(stock){
    const row=document.createElement('div'); row.className='row';
    const left=document.createElement('div'); left.className='cell sym';
    left.innerHTML=`
        <div><div class="ticker">${stock.ticker}</div><div class="name">${stock.name}</div></div>
        <div class="chips" data-chips><span class="chip">${stock.exchange}</span><span class="chip">Trends: ${stock.trendsQuery||stock.name}</span></div>
        <div class="metrics" data-metrics><div>Loading...</div></div>
        <div class="actions"><button class="ghost" data-remove>Remove</button></div>`;

    const mid=document.createElement('div'); mid.className='cell trends';
    const tFrame=document.createElement('iframe'); tFrame.loading='lazy'; tFrame.src=trendSrc(stock.trendsQuery||stock.name);
    mid.appendChild(tFrame);

    const right=document.createElement('div'); right.className='cell mini';
    const tvbox=document.createElement('div'); tvbox.className='tvbox'; right.appendChild(tvbox);

    row.appendChild(left); row.appendChild(mid); row.appendChild(right);
    table.appendChild(row);

    lazyMountMiniChart(tvbox, `${stock.exchange}:${stock.ticker}`);
    fetchValuation(stock.ticker).then(v=>{ if(v) renderValuation(left, v); else left.querySelector('[data-metrics]').innerHTML='<div>n/a</div>'; });

    state.rows.push({ el:row, data:stock, tFrame, tvbox });
  }

  function lazyMountMiniChart(container,symbol){
    const mount=()=>{ if(container.dataset.mounted) return; container.dataset.mounted='1'; addTVMini(container, symbol); };
    const io=new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ mount(); io.disconnect(); } }); },{rootMargin:'200px'});
    io.observe(container);
  }

  function addTVMini(container,symbol){
    try{
      const script=document.createElement('script'); script.type='text/javascript'; script.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js'; script.async=true; script.text=safeJSON(tvMiniConfig(symbol)); container.appendChild(script);
    }catch(e){ console.error('TV embed error', e); }
  }

  document.getElementById('table').addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-remove]'); if(!btn) return;
    const row=btn.closest('.row');
    const sym=row.querySelector('.ticker')?.textContent.trim();
    row.remove();
    state.rows=state.rows.filter(r=>r.data.ticker!==sym);
  });

  document.getElementById('addBtn').addEventListener('click',()=>{
    const input=document.getElementById('add');
    const raw=input.value.trim().toUpperCase();
    if(!raw) return;
    if(state.rows.some(r=>r.data.ticker===raw)) { input.value=''; return; }
    const item={ ticker:raw, name:raw, exchange:'NASDAQ', trendsQuery:raw };
    makeRow(item); input.value='';
  });

  document.getElementById('range').addEventListener('change',e=>{
    state.range=e.target.value;
    state.rows.forEach(r=>{ r.tvbox.innerHTML=''; r.tvbox.removeAttribute('data-mounted'); lazyMountMiniChart(r.tvbox, `${r.data.exchange}:${r.data.ticker}`); });
  });
  document.getElementById('geo').addEventListener('change',e=>{ state.geo=e.target.value; refreshTrends(); });
  document.getElementById('trendTime').addEventListener('change',e=>{ state.trendTime=e.target.value; refreshTrends(); });
  function refreshTrends(){ state.rows.forEach(r=>{ r.tFrame.src=trendSrc(r.data.trendsQuery||r.data.name); }); }

async function fetchFearGreed() {
  try {
    const html = await fetch(
      'https://r.jina.ai/http://edition.cnn.com/markets/fear-and-greed'
    ).then(r => r.text());

    const m =
      /dial-number[^>]*>(\d{1,3})/i.exec(html) ||
      /Fear\s*&\s*Greed[^\d]*(\d{1,3})/i.exec(html) ||
      /"score"\s*:\s*(\d{1,3})/i.exec(html);

    if (m) {
      const v = Math.max(0, Math.min(100, parseInt(m[1], 10)));
      return { value: v, source: 'CNN' };
    }
  } catch (e) {
    console.error('FNG fetch error', e);
  }

  try {
    const alt = await fetchFGStockComposite();
    if (alt) return alt;
  } catch (e) {
    console.error('Alt FNG error', e);
  }

  return null;
}



async function fetchValuation(ticker){
  // 1) Try summary (richer fields)
  try{
    const r = await fetch(`${API_BASE}/api/yahoo/summary?symbol=${encodeURIComponent(ticker)}`);
    if (r.ok) {
      const j = await r.json();
      const d = j?.quoteSummary?.result?.[0];
      if (d){
        const pe  = d.summaryDetail?.trailingPE?.raw ?? d.defaultKeyStatistics?.trailingPE?.raw ?? null;
        const ps  = d.summaryDetail?.priceToSalesTrailing12Months?.raw ?? null;
        const evs = d.defaultKeyStatistics?.enterpriseToRevenue?.raw ?? d.financialData?.enterpriseToRevenue?.raw ?? null;
        const mcap = d.price?.marketCap?.fmt ?? (d.price?.marketCap?.raw ? `$${Math.round(d.price.marketCap.raw/1e9)}B` : null);
        return { pe, ps, evs, mcap };
      }
    }
  }catch{}

  // 2) Fallback to quote
  try{
    const r2 = await fetch(`${API_BASE}/api/yahoo/quote?symbol=${encodeURIComponent(ticker)}`);
    if (r2.ok) {
      const j2 = await r2.json();
      const q  = j2?.quoteResponse?.result?.[0];
      if (q){
        const pe  = q.trailingPE ?? null;
        const ps  = q.priceToSalesTrailing12Months ?? null;
        const evs = null; // not available here
        const mcap = q.marketCap ? `$${Math.round(q.marketCap/1e9)}B` : null;
        return { pe, ps, evs, mcap };
      }
    }
  }catch{}

  return null;
}

  function renderValuation(left, v){
    const m=left.querySelector('[data-metrics]');
    if(!m) return;
    m.innerHTML='';
    const add=(k,val)=>{
      if(val==null) return;
      const d=document.createElement('div');
      d.style.display='flex';
      d.style.justifyContent='space-between';
      d.innerHTML=`<span>${k}</span><b>${typeof val==='number'? Number(val.toFixed(2)) : val}</b>`;
      m.appendChild(d);
    };
    add('MCap', v.mcap);
    add('P/E', v.pe);
    add('P/S', v.ps);
    add('EV/S', v.evs);
  }

  WATCHLIST.forEach(makeRow);

 async function fetchFGStockComposite(){
  async function lastClose(symbol){
    try{
      const r = await fetch(`${API_BASE}/api/yahoo/chart?symbol=${encodeURIComponent(symbol)}&range=5d&interval=1d`);
      const j = await r.json();
      const arr = j?.chart?.result?.[0]?.indicators?.quote?.[0]?.close || [];
      const v = arr.filter(x => Number.isFinite(x)).slice(-1)[0];
      return Number(v);
    }catch{ return null; }
  }
  const [vix, pcr] = await Promise.all([ lastClose('^VIX'), lastClose('^CPC') ]);
  if(!Number.isFinite(vix) && !Number.isFinite(pcr)) return null;
  const norm = (x,min,max)=> Math.max(0, Math.min(100, 100*(1-(x-min)/(max-min))));
  const vixScore = Number.isFinite(vix) ? norm(vix,12,40) : null;
  const pcrScore = Number.isFinite(pcr) ? norm(pcr,0.7,1.3) : null;
  const parts = [vixScore,pcrScore].filter(n=>Number.isFinite(n));
  return { value: Math.round(parts.reduce((a,b)=>a+b,0)/parts.length), source: 'stock composite' };
}

    const [vix,pcr]=await Promise.all([ lastClose('^VIX'), lastClose('^CPC') ]);
    if(!Number.isFinite(vix) && !Number.isFinite(pcr)) return null;
    const norm=(x,min,max)=>Math.max(0,Math.min(100,100*(1-(x-min)/(max-min))));
    const vixScore=Number.isFinite(vix)? norm(vix,12,40):null;
    const pcrScore=Number.isFinite(pcr)? norm(pcr,0.7,1.3):null;
    const parts=[vixScore,pcrScore].filter(n=>Number.isFinite(n));
    const val=Math.round(parts.reduce((a,b)=>a+b,0)/parts.length);
    return { value:val, source:'stock composite' };
  }
</script>
</body>
</html>
