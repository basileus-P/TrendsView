<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BREAKTHROUGH Monitor</title>
  <style>
    :root{--bg:#0b0f14;--panel:#131a22;--panel-2:#0f151c;--text:#e6edf3;--muted:#a5b1bf;--accent:#3ea6ff;--good:#18b663;--bad:#ff4d4f;--chip:#1b2430;--border:#243040}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:linear-gradient(180deg,rgba(11,15,20,.9),rgba(11,15,20,.6));border-bottom:1px solid var(--border)}
    .wrap{max-width:1300px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .control{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .control label{color:var(--muted);font-size:12px}
    select,input[type=text]{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px;outline:none}
    button{background:var(--accent);color:#071018;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}

    /* Fear & Greed */
    .fng{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);background:var(--panel);border-radius:10px}
    .gauge{--v:50;width:160px;height:80px;background:conic-gradient(#ff4d4f calc(var(--v)*1%),#ffd166 0 calc(50*1%),#18b663 0);mask:radial-gradient(80px at 50% 100%,transparent 79px,#000 80px);border-radius:0 0 160px 160px;position:relative}
    .needle{position:absolute;left:50%;bottom:0;width:2px;height:78px;background:#e6edf3;transform-origin:bottom center;transform:rotate(calc(-90deg + (var(--v)*1.8deg)));transition:transform .3s ease}
    .fng span{font-size:12px;color:var(--muted)}

    .table{max-width:1300px;margin:14px auto;border-collapse:separate;border-spacing:0 10px;padding:0 8px 24px}
    .row{display:grid;grid-template-columns:200px minmax(360px,1fr) minmax(420px,1fr);gap:12px;align-items:stretch}
    .row+.row{margin-top:12px}
    .cell{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;min-height:340px;display:flex}

    .sym{padding:12px;display:flex;flex-direction:column;gap:8px;width:100%;align-items:flex-start}
    .ticker{font-size:18px;font-weight:800;letter-spacing:.5px}
    .name{color:var(--muted);font-size:12px;line-height:1.3}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:11px;white-space:nowrap}
    .metrics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 12px;font-size:12px;color:var(--muted);width:100%}
    .metrics b{color:var(--text);font-weight:700}
    .actions{display:flex;gap:8px}

    .trends{background:var(--panel-2);border-right:1px solid var(--border);width:100%}
    .trends iframe{width:100%;height:100%;min-height:340px;border:0}

    .mini{position:relative;width:100%;background:var(--panel-2)}
    .mini .tvbox{position:relative;min-height:340px}
    .mini .vals{position:absolute;bottom:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap}

    .row-head{display:grid;grid-template-columns:200px 1fr 1fr;gap:12px;padding:0 8px;margin:10px auto;max-width:1300px;color:var(--muted);font-size:12px}
    @media(max-width:1100px){.row,.row-head{grid-template-columns:1fr}.cell{min-height:340px}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸš€ BREAKTHROUGH Monitor</h1>
      <div class="controls">
        <div class="fng">
          <div class="gauge" id="gauge"><div class="needle" id="needle"></div></div>
          <div>
            <div style="font-weight:700">Fear/Greed: <span id="fngVal">â€“</span></div>
            <span id="fngSrc">(stock composite)</span>
          </div>
        </div>
        <div class="control"><label for="trendGeo">Geo</label>
          <select id="trendGeo"><option value="US" selected>US</option><option value="">Worldwide</option></select>
        </div>
        <div class="control"><label for="trendRange">Trends</label>
          <select id="trendRange"><option value="now 7-d">Past 7d</option><option value="today 1-m" selected>Past 30d</option><option value="today 3-m">Past 90d</option><option value="today 12-m">Past 12m</option></select>
        </div>
        <div class="control"><label for="chartRange">Charts</label>
          <select id="chartRange"><option value="1M">1M</option><option value="3M">3M</option><option value="6M">6M</option><option value="12M" selected>12M</option><option value="ALL">ALL</option></select>
        </div>
        <div class="control"><label for="add">Add ticker</label>
          <input id="add" type="text" placeholder="e.g. PLTR" />
          <button id="addBtn">Add</button>
        </div>
      </div>
    </div>
  </header>

  <div class="row-head"><div>Symbol</div><div>Google Trends</div><div>Mini chart + Valuation</div></div>
  <main class="table" id="table"></main>

  <script>
    // --- Seeds ---
    const WATCHLIST=[
      { ticker:'PLTR', name:'Palantir', exchange:'NYSE', trendsQuery:'Palantir' },
      { ticker:'QSI', name:'Quantum-Si', exchange:'NASDAQ', trendsQuery:'Quantum-Si' },
      { ticker:'APLD', name:'Applied Digital', exchange:'NASDAQ', trendsQuery:'Applied Digital' },
      { ticker:'INOD', name:'Innodata', exchange:'NASDAQ', trendsQuery:'Innodata' },
      { ticker:'NVDA', name:'NVIDIA', exchange:'NASDAQ', trendsQuery:'NVIDIA' }
    ];

    const state={ rows:[], trendGeo:'US', trendRange:'today 1-m', chartRange:'12M' };

    // --- Stock-only Fear/Greed composite (VIX + CBOE Put/Call via Yahoo chart; CORS via r.jina.ai) ---
    async function lastClose(symbol){
      try{
        const url=`https://r.jina.ai/http://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=5d&interval=1d`;
        const t=await (await fetch(url)).text();
        const j=JSON.parse(t);
        const arr=j?.chart?.result?.[0]?.indicators?.quote?.[0]?.close||[];
        const v=arr.filter(x=>Number.isFinite(x)).slice(-1)[0];
        return Number(v);
      }catch{return null}
    }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function scaleToScore(x, min, max, invert=false){ const p=clamp01((x-min)/(max-min)); const v=invert? (1-p):p; return Math.round(v*100); }
    async function fetchFGStock(){
      const [vix,pcr]=await Promise.all([lastClose('^VIX'), lastClose('^CPC')]);
      const vixScore=Number.isFinite(vix)? scaleToScore(vix,12,40,true):null; // higher vix => lower score
      const pcrScore=Number.isFinite(pcr)? scaleToScore(pcr,0.7,1.3,true):null; // higher pcr => lower score
      const parts=[vixScore,pcrScore].filter(n=>Number.isFinite(n));
      if(!parts.length) return null;
      const score=Math.round(parts.reduce((a,b)=>a+b,0)/parts.length);
      return {value:score, source:'stock composite'};
    }
    function setFNG(v,src){ document.getElementById('gauge').style.setProperty('--v',v); document.getElementById('needle').style.transform=`rotate(${ -90 + (v*1.8) }deg)`; document.getElementById('fngVal').textContent=String(v); if(src) document.getElementById('fngSrc').textContent=`(${src})`; }
    (async()=>{ const r=await fetchFGStock(); if(r) setFNG(r.value,r.source); })();

    // --- Helpers ---
    function tvMiniConfig(symbol){ return { symbol, width:'100%', height:340, locale:'en', dateRange:state.chartRange, colorTheme:'dark', isTransparent:true, autosize:true, largeChartUrl:`https://www.tradingview.com/symbols/${symbol}/`, noTimeScale:false }; }
    function safeJSON(o){ const s=JSON.stringify(o); return s.replace(/</g,'\\u003c').replace(/>/g,'\\u003e'); }
    function trendSrc(query){ const req={ comparisonItem:[{ keyword: query, geo: state.trendGeo, time: state.trendRange }], category:0 }; const tz=-new Date().getTimezoneOffset(); const base='https://trends.google.com/trends/embed/explore/TIMESERIES'; const params=new URLSearchParams({ hl:'en-US', req: JSON.stringify(req), tz: String(tz) }); return `${base}?${params.toString()}`; }

    // --- Render rows ---
    const table=document.getElementById('table');
    function makeRow(stock){
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('div'); left.className='cell sym';
      left.innerHTML=`
        <div><div class="ticker">${stock.ticker}</div><div class="name">${stock.name}</div></div>
        <div class="chips" data-chips>
          <span class="chip">${stock.exchange}</span>
          <span class="chip">Trends: ${stock.trendsQuery||stock.name}</span>
        </div>
        <div class="metrics" data-metrics>
          <div style="display:flex;justify-content:space-between"><span>MCap</span><b>â€”</b></div>
          <div style="display:flex;justify-content:space-between"><span>P/E</span><b>â€”</b></div>
          <div style="display:flex;justify-content:space-between"><span>P/S</span><b>â€”</b></div>
          <div style="display:flex;justify-content:space-between"><span>EV/S</span><b>â€”</b></div>
        </div>
        <div class="actions"><button class="ghost" data-remove>Remove</button></div>`;

      const mid=document.createElement('div'); mid.className='cell trends';
      const tFrame=document.createElement('iframe'); tFrame.loading='lazy'; tFrame.title=`${stock.trendsQuery||stock.name} â€” Google Trends`; tFrame.src=trendSrc(stock.trendsQuery||stock.name); mid.appendChild(tFrame);

      const right=document.createElement('div'); right.className='cell mini';
      const tvbox=document.createElement('div'); tvbox.className='tvbox'; right.appendChild(tvbox);
      const chips=document.createElement('div'); chips.className='vals'; right.appendChild(chips);

      // Mount chart lazily
      lazyMountMiniChart(tvbox, `${stock.exchange}:${stock.ticker}`);

      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      table.appendChild(row);

      const res={ el:row, data:stock, tvbox, tFrame };
      state.rows.push(res);
      // Fetch valuation -> chips + metrics
      fetchValuation(stock.ticker).then(v=>{ if(!v) return; renderValuation(res,v); });
    }

    function lazyMountMiniChart(container,symbol){ const mount=()=>{ if(container.dataset.mounted) return; container.dataset.mounted='1'; addTVMini(container, symbol); }; const io=new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ mount(); io.disconnect(); } }); },{rootMargin:'200px'}); io.observe(container); }
    function addTVMini(container,symbol){ try{ const s=document.createElement('script'); s.type='text/javascript'; s.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js'; s.async=true; s.text=safeJSON(tvMiniConfig(symbol)); container.appendChild(s); }catch(e){ console.error(e); } }

    // --- Valuation via Yahoo Finance (CORS proxy) ---
    async function fetchValuation(ticker){ const url=`https://r.jina.ai/http://query1.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=price,summaryDetail,defaultKeyStatistics,financialData`; try{ const r=await fetch(url); if(!r.ok) return null; const txt=await r.text(); const j=JSON.parse(txt); const d=j?.quoteSummary?.result?.[0]; if(!d) return null; const pe=d.summaryDetail?.trailingPE?.raw ?? d.defaultKeyStatistics?.trailingPE?.raw ?? null; const ps=d.summaryDetail?.priceToSalesTrailing12Months?.raw ?? null; const evs=d.defaultKeyStatistics?.enterpriseToRevenue?.raw ?? d.financialData?.enterpriseToRevenue?.raw ?? null; const mcap=d.price?.marketCap?.fmt ?? (d.price?.marketCap?.raw? `$${Math.round(d.price.marketCap.raw/1e9)}B` : null); return {pe,ps,evs,mcap}; }catch{return null} }
    function renderValuation(rowRef,v){ const wrap=rowRef.el.querySelector('[data-chips]'); const addChip=(k,val)=>{ if(val==null) return; const s=document.createElement('span'); s.className='chip'; s.textContent=`${k}: ${typeof val==='number'? Number(val.toFixed(2)) : val}`; wrap.appendChild(s); }; addChip('MCap',v.mcap); addChip('P/E',v.pe); addChip('P/S',v.ps); addChip('EV/S',v.evs); const m=rowRef.el.querySelector('[data-metrics]'); if(m){ const fmt=(x)=> typeof x==='number'? Number(x.toFixed(2)) : x; m.innerHTML=''; const add=(k,val)=>{ if(val==null) return; const d=document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.innerHTML=`<span>${k}</span><b>${fmt(val)}</b>`; m.appendChild(d); }; add('MCap',v.mcap); add('P/E',v.pe); add('P/S',v.ps); add('EV/S',v.evs); } }

    // --- Controls ---
    document.getElementById('table').addEventListener('click',(e)=>{ const btn=e.target.closest('[data-remove]'); if(!btn) return; const row=btn.closest('.row'); const sym=row.querySelector('.ticker')?.textContent.trim(); row.remove(); state.rows=state.rows.filter(r=>r.data.ticker!==sym); });
    document.getElementById('addBtn').addEventListener('click',()=>{ const input=document.getElementById('add'); const raw=input.value.trim().toUpperCase(); if(!raw) return; if(state.rows.some(r=>r.data.ticker===raw)) { input.value=''; return; } const item={ ticker:raw, name:raw, exchange:'NASDAQ', trendsQuery:raw }; makeRow(item); input.value=''; });
    document.getElementById('chartRange').addEventListener('change',e=>{ state.chartRange=e.target.value; state.rows.forEach(r=>{ r.tvbox.innerHTML=''; r.tvbox.removeAttribute('data-mounted'); lazyMountMiniChart(r.tvbox, `${r.data.exchange}:${r.data.ticker}`); }); });
    document.getElementById('trendGeo').addEventListener('change',e=>{ state.trendGeo=e.target.value; refreshTrends(); });
    document.getElementById('trendRange').addEventListener('change',e=>{ state.trendRange=e.target.value; refreshTrends(); });
    function refreshTrends(){ state.rows.forEach(r=> r.tFrame.src = trendSrc(r.data.trendsQuery||r.data.name)); }

    // --- Init ---
    WATCHLIST.forEach(makeRow);
  </script>
</body>
</html>
