<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BREAKTHROUGH Monitor</title>
  <style>
    :root{--bg:#0b0f14;--panel:#131a22;--panel-2:#0f151c;--text:#e6edf3;--muted:#a5b1bf;--accent:#3ea6ff;--good:#18b663;--bad:#ff4d4f;--chip:#1b2430;--border:#243040}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:linear-gradient(180deg,rgba(11,15,20,.9),rgba(11,15,20,.6));border-bottom:1px solid var(--border)}
    .wrap{max-width:1300px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .control{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .control label{color:var(--muted);font-size:12px}
    select,input[type=text]{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px;outline:none}
    button{background:var(--accent);color:#071018;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}

    /* Fear & Greed */
    .fng{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);background:var(--panel);border-radius:10px}
    .gauge{--v:50;width:160px;height:80px;background:conic-gradient(#ff4d4f calc(var(--v)*1%),#ffd166 0 calc(50*1%),#18b663 0);mask:radial-gradient(80px at 50% 100%,transparent 79px,#000 80px);border-radius:0 0 160px 160px;position:relative}
    .needle{position:absolute;left:50%;bottom:0;width:2px;height:78px;background:#e6edf3;transform-origin:bottom center;transform:rotate(calc(-90deg + (var(--v)*1.8deg)));transition:transform .3s ease}
    .fng span{font-size:12px;color:var(--muted)}

    .table{max-width:1300px;margin:14px auto;border-collapse:separate;border-spacing:0 10px;padding:0 8px 24px}
    .row{display:grid;grid-template-columns:200px minmax(360px,1fr) minmax(360px,1fr);gap:12px;align-items:stretch}
    .row+.row{margin-top:12px}
    .cell{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;min-height:360px;display:flex}
    .sym{padding:12px;display:grid;grid-template-rows:auto 1fr auto;width:100%;gap:8px}
    .ticker{font-size:18px;font-weight:800;letter-spacing:.5px}
    .name{color:var(--muted);font-size:12px;line-height:1.3}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:11px}
    .score{font-weight:800}
    .score.good{color:var(--good)}
    .score.bad{color:var(--bad)}
    .actions{display:flex;gap:8px}

    .trends{background:var(--panel-2);border-right:1px solid var(--border);width:100%;position:relative;overflow:hidden}
    .scaleWrap{transform:scale(.86);transform-origin:top left;width:116%;height:116%}
    .trends iframe{width:100%;height:100%;min-height:360px;border:0}

    .mini{position:relative;width:100%;background:var(--panel-2)}
    .mini .tvbox{position:relative;min-height:360px}
    .mini .vals{position:absolute;bottom:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap}

    .row-head{display:grid;grid-template-columns:200px 1fr 1fr;gap:12px;padding:0 8px;margin:10px auto;max-width:1300px;color:var(--muted);font-size:12px}
    @media(max-width:1100px){.row,.row-head{grid-template-columns:1fr}.cell{min-height:360px}}

    /* Inline error banner */
    #err{display:none;position:fixed;bottom:10px;left:10px;background:#2a0000;color:#ffdede;border:1px solid #7a0000;border-radius:10px;padding:8px 12px;font-size:12px;z-index:9999}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸš€ BREAKTHROUGH Monitor</h1>
      <div class="controls">
        <div class="fng" id="fngBox">
          <div class="gauge" id="gauge"><div class="needle" id="needle"></div></div>
          <div>
            <div style="font-weight:700">Fear/Greed: <span id="fngVal">50</span></div>
            <span id="fngSrc">(manual fallback)</span>
          </div>
          <input id="fngInput" type="range" min="0" max="100" value="50" />
        </div>
        <div class="control"><label for="range">Chart range</label>
          <select id="range"><option value="1M">1M</option><option value="3M">3M</option><option value="6M">6M</option><option value="12M" selected>12M</option><option value="ALL">ALL</option></select>
        </div>
        <div class="control"><label for="geo">Trends Geo</label>
          <select id="geo"><option value="US" selected>US</option><option value="">Worldwide</option></select>
        </div>
        <div class="control"><label for="trendTime">Trends range</label>
          <select id="trendTime"><option value="now 7-d">7d</option><option value="today 1-m" selected>30d</option><option value="today 3-m">90d</option><option value="today 12-m">12m</option></select>
        </div>
        <div class="control"><label for="add">Add ticker</label>
          <input id="add" type="text" placeholder="e.g. PLTR" />
          <button id="addBtn">Add</button>
        </div>
      </div>
    </div>
  </header>

  <div class="row-head"><div>Symbol</div><div>Google Trends</div><div>Mini chart + Valuation</div></div>
  <main class="table" id="table"></main>
  <div id="err"></div>

  <script>
    // --- Basic error banner ---
    window.addEventListener('error', (e)=>{
      const el=document.getElementById('err'); el.textContent=`JS error: ${e.message} @ ${e.filename}:${e.lineno}`; el.style.display='block';
    });

    // --- Watchlist ---
    const WATCHLIST=[
      { ticker:'PLTR', name:'Palantir', exchange:'NYSE', trendsQuery:'Palantir' },
      { ticker:'QSI', name:'Quantum-Si', exchange:'NASDAQ', trendsQuery:'Quantum-Si' },
      { ticker:'APLD', name:'Applied Digital', exchange:'NASDAQ', trendsQuery:'Applied Digital' },
      { ticker:'INOD', name:'Innodata', exchange:'NASDAQ', trendsQuery:'Innodata' },
      { ticker:'NVDA', name:'NVIDIA', exchange:'NASDAQ', trendsQuery:'NVIDIA' }
    ];

    const state={ rows:[], range:'12M', geo:'US', trendTime:'today 1-m' };

    // --- FNG gauge ---
    const fngInput=document.getElementById('fngInput');
    const fngVal=document.getElementById('fngVal');
    const needle=document.getElementById('needle');
    const fngSrc=document.getElementById('fngSrc');
    function setFNG(v,src){ document.getElementById('gauge').style.setProperty('--v', v); needle.style.transform=`rotate(${ -90 + (v*1.8) }deg)`; fngVal.textContent=v; if(src) fngSrc.textContent=`(${src})`; localStorage.setItem('bt_fng', v); }
    setFNG(+localStorage.getItem('bt_fng')||50,'manual');
    fngInput.addEventListener('input',e=>setFNG(+e.target.value,'manual'));
    (async()=>{ const live=await fetchFearGreed(); if(live){ setFNG(live.value, live.source); fngInput.value=live.value; } })();

    // --- Helpers ---
    function tvMiniConfig(ticker){ return { symbol:ticker, width:'100%', height:360, locale:'en', dateRange:state.range, colorTheme:'dark', isTransparent:true, autosize:true, largeChartUrl:`https://www.tradingview.com/symbols/${ticker}/`, noTimeScale:false }; }
    function safeJSON(obj){ const s=JSON.stringify(obj); return s.split('<').join('\\u003c').split('>').join('\\u003e'); }

    function trendSrc(query){
      const req={ comparisonItem:[{ keyword: query, geo: state.geo, time: state.trendTime }], category:0 };
      const tz=-new Date().getTimezoneOffset();
      const base='https://trends.google.com/trends/embed/explore/TIMESERIES';
      const params=new URLSearchParams({ hl:'en-US', req: JSON.stringify(req), tz: String(tz) });
      return `${base}?${params.toString()}`;
    }

    function makeRow(stock){
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('div'); left.className='cell sym';
      left.innerHTML=`
        <div><div class=\"ticker\">${stock.ticker}</div><div class=\"name\">${stock.name}</div></div>
        <div class=\"chips\" data-chips><span class=\"chip\">${stock.exchange}</span><span class=\"chip\">Trends: ${stock.trendsQuery||stock.name}</span></div>
        <div class=\"actions\"><button class=\"ghost\" data-remove>Remove</button></div>`;

      const mid=document.createElement('div'); mid.className='cell trends';
      const scaleWrap=document.createElement('div'); scaleWrap.className='scaleWrap';
      const tFrame=document.createElement('iframe'); tFrame.loading='lazy'; tFrame.title=`${stock.trendsQuery||stock.name} â€” Google Trends`; tFrame.src=trendSrc(stock.trendsQuery||stock.name);
      scaleWrap.appendChild(tFrame); mid.appendChild(scaleWrap);

      const right=document.createElement('div'); right.className='cell mini';
      const tvbox=document.createElement('div'); tvbox.className='tvbox'; right.appendChild(tvbox);
      const chips=document.createElement('div'); chips.className='vals'; right.appendChild(chips);

      const scoreEl=document.createElement('span'); scoreEl.className='chip score'; scoreEl.textContent='Value â€”'; chips.appendChild(scoreEl);

      lazyMountMiniChart(tvbox, `${stock.exchange}:${stock.ticker}`);

      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      table.appendChild(row);

      const res={ el:row, data:stock, tvbox, tFrame, scoreEl };
      state.rows.push(res);
      fetchValuation(stock.ticker).then(v=>{ if(!v) return; renderValuationChips(res, v); });
    }

    function lazyMountMiniChart(container,symbol){
      const mount=()=>{ if(container.dataset.mounted) return; container.dataset.mounted='1'; addTVMini(container, symbol); };
      const io=new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ mount(); io.disconnect(); } }); },{rootMargin:'200px'});
      io.observe(container);
    }

    function addTVMini(container,symbol){
      try{
        const script=document.createElement('script'); script.type='text/javascript'; script.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js'; script.async=true; script.text=safeJSON(tvMiniConfig(symbol)); container.appendChild(script);
      }catch(e){ console.error('TV embed error', e); }
    }

    // Remove via delegation
    document.getElementById('table').addEventListener('click', (e)=>{
      const btn=e.target.closest('[data-remove]'); if(!btn) return; const row=btn.closest('.row'); const sym=row.querySelector('.ticker')?.textContent.trim(); row.remove(); state.rows=state.rows.filter(r=>r.data.ticker!==sym);
    });

    // Controls
    const table=document.getElementById('table');
    document.getElementById('addBtn').addEventListener('click',()=>{
      const input=document.getElementById('add'); const raw=input.value.trim().toUpperCase(); if(!raw) return;
      if(state.rows.some(r=>r.data.ticker===raw)) { input.value=''; return; }
      const item={ ticker:raw, name:raw, exchange:'NASDAQ', trendsQuery:raw }; makeRow(item); input.value='';
    });
    document.getElementById('range').addEventListener('change',e=>{
      state.range=e.target.value; state.rows.forEach(r=>{ r.tvbox.innerHTML=''; r.tvbox.removeAttribute('data-mounted'); lazyMountMiniChart(r.tvbox, `${r.data.exchange}:${r.data.ticker}`); });
    });
    document.getElementById('geo').addEventListener('change',e=>{ state.geo=e.target.value; refreshTrends(); });
    document.getElementById('trendTime').addEventListener('change',e=>{ state.trendTime=e.target.value; refreshTrends(); });
    function refreshTrends(){ state.rows.forEach(r=>{ r.tFrame.src=trendSrc(r.data.trendsQuery||r.data.name); }); }

    // Live Fear & Greed (best-effort)
    async function fetchFearGreed(){
      try{ const r=await fetch('https://production.dataviz.cnn.io/index/fearandgreed/score'); if(r.ok){ const j=await r.json(); const v=Number(j?.fear_and_greed?.score ?? j?.score); if(Number.isFinite(v)) return {value:v, source:'CNN'}; } }catch{}
      try{ const r=await fetch('https://api.alternative.me/fng/?limit=1&format=json'); if(r.ok){ const j=await r.json(); const v=Number(j?.data?.[0]?.value); if(Number.isFinite(v)) return {value:v, source:'Crypto FNG'}; } }catch{}
      return null;
    }

    // Live valuation via Yahoo Finance quoteSummary (may be CORS-blocked regionally)
    async function fetchValuation(ticker){
      const url=`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=price,summaryDetail,defaultKeyStatistics,financialData`;
      try{ const r=await fetch(url); if(!r.ok) return null; const j=await r.json(); const d=j?.quoteSummary?.result?.[0]; if(!d) return null; const pe=d.summaryDetail?.trailingPE?.raw ?? d.defaultKeyStatistics?.trailingPE?.raw ?? null; const ps=d.summaryDetail?.priceToSalesTrailing12Months?.raw ?? null; const evs=d.defaultKeyStatistics?.enterpriseToRevenue?.raw ?? d.financialData?.enterpriseToRevenue?.raw ?? null; const mcap=d.price?.marketCap?.fmt ?? (d.price?.marketCap?.raw? `$${Math.round(d.price.marketCap.raw/1e9)}B` : null); return {pe,ps,evs,mcap}; }catch{return null}
    }
    function renderValuationChips(rowRef,v){ const wrap=rowRef.el.querySelector('[data-chips]'); const add=(label,val)=>{ if(val==null) return; const s=document.createElement('span'); s.className='chip'; s.textContent=`${label}: ${typeof val==='number'? Number(val.toFixed(2)) : val}`; wrap.appendChild(s); }; add('MCap',v.mcap); add('P/E',v.pe); add('P/S',v.ps); add('EV/S',v.evs); }

    // Init
    WATCHLIST.forEach(makeRow);
  </script>
</body>
</html>
