<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BREAKTHROUGH Monitor</title>
  <style>
    :root{--bg:#0b0f14;--panel:#131a22;--panel-2:#0f151c;--text:#e6edf3;--muted:#a5b1bf;--accent:#3ea6ff;--good:#18b663;--bad:#ff4d4f;--chip:#1b2430;--border:#243040}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:linear-gradient(180deg,rgba(11,15,20,.9),rgba(11,15,20,.6));border-bottom:1px solid var(--border)}
    .wrap{max-width:1300px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .control{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .control label{color:var(--muted);font-size:12px}
    select,input[type=text]{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px;outline:none}
    button{background:var(--accent);color:#071018;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}

    .fng{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);background:var(--panel);border-radius:10px}
    .gauge{--v:50;width:160px;height:80px;background:conic-gradient(#ff4d4f calc(var(--v)*1%),#ffd166 0 calc(50*1%),#18b663 0);mask:radial-gradient(80px at 50% 100%,transparent 79px,#000 80px);border-radius:0 0 160px 160px;position:relative}
    .needle{position:absolute;left:50%;bottom:0;width:2px;height:78px;background:#e6edf3;transform-origin:bottom center;transform:rotate(calc(-90deg + (var(--v)*1.8deg)));transition:transform .3s ease}
    .fng span{font-size:12px;color:var(--muted)}

    .table{max-width:1300px;margin:14px auto;border-collapse:separate;border-spacing:0 10px;padding:0 8px 24px}
    .row{display:grid;grid-template-columns:200px minmax(360px,1fr) minmax(360px,1fr);gap:12px;align-items:stretch}
    .row+.row{margin-top:12px}
    .cell{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;min-height:240px;display:flex}
    .sym{padding:12px;display:grid;grid-template-rows:auto 1fr auto;width:100%;gap:8px}
    .ticker{font-size:18px;font-weight:800;letter-spacing:.5px}
    .name{color:var(--muted);font-size:12px;line-height:1.3}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:11px}
    .score{font-weight:800}
    .score.good{color:var(--good)}
    .score.bad{color:var(--bad)}
    .actions{display:flex;gap:8px}

    .trends{background:var(--panel-2);border-right:1px solid var(--border);width:100%}
    .trends iframe{width:100%;height:100%;min-height:240px;border:0}

    .mini{position:relative;width:100%;background:var(--panel-2)}
    .mini .tvbox{position:relative;min-height:240px}
    .mini .vals{position:absolute;bottom:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap}

    .row-head{display:grid;grid-template-columns:200px 1fr 1fr;gap:12px;padding:0 8px;margin:10px auto;max-width:1300px;color:var(--muted);font-size:12px}
    @media(max-width:1100px){.row,.row-head{grid-template-columns:1fr}.cell{min-height:240px}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸš€ BREAKTHROUGH Monitor</h1>
      <div class="controls">
        <div class="fng" id="fngBox">
          <div class="gauge" id="gauge"><div class="needle" id="needle"></div></div>
          <div>
            <div style="font-weight:700">Fear/Greed: <span id="fngVal">50</span></div>
            <span>Manual for now â€” can wire live index later.</span>
          </div>
          <input id="fngInput" type="range" min="0" max="100" value="50" />
        </div>
        <div class="control"><label for="range">Chart range</label>
          <select id="range">
            <option value="1M">1M</option>
            <option value="3M">3M</option>
            <option value="6M">6M</option>
            <option value="12M" selected>12M</option>
            <option value="ALL">ALL</option>
          </select>
        </div>
        <div class="control"><label for="geo">Trends Geo</label>
          <select id="geo"><option value="US" selected>US</option><option value="">Worldwide</option></select>
        </div>
        <div class="control"><label for="trendTime">Trends range</label>
          <select id="trendTime"><option value="now 7-d">7d</option><option value="today 1-m" selected>30d</option><option value="today 3-m">90d</option><option value="today 12-m">12m</option></select>
        </div>
        <div class="control"><label for="add">Add ticker</label>
          <input id="add" type="text" placeholder="e.g. PLTR" />
          <button id="addBtn">Add</button>
        </div>
      </div>
    </div>
  </header>

  <div class="row-head"><div>Symbol</div><div>Google Trends</div><div>Mini chart + Valuation</div></div>

  <main class="table" id="table"></main>

  <script>
    // --- Watchlist ---
    const WATCHLIST=[
      { ticker:'PLTR', name:'Palantir', exchange:'NYSE', trendsQuery:'Palantir' },
      { ticker:'QSI', name:'Quantum-Si', exchange:'NASDAQ', trendsQuery:'Quantum-Si' },
      { ticker:'APLD', name:'Applied Digital', exchange:'NASDAQ', trendsQuery:'Applied Digital' },
    ];

    const state={ rows:[], range:'12M', geo:'US', trendTime:'today 1-m' };

    // --- Fear/Greed gauge (manual) ---
    const fngInput=document.getElementById('fngInput');
    const fngVal=document.getElementById('fngVal');
    const needle=document.getElementById('needle');
    function setFNG(v){ document.getElementById('gauge').style.setProperty('--v', v); needle.style.transform=`rotate(${ -90 + (v*1.8) }deg)`; fngVal.textContent=v; localStorage.setItem('bt_fng', v); }
    setFNG(+localStorage.getItem('bt_fng')||50);
    fngInput.addEventListener('input',e=>setFNG(+e.target.value));

    // --- Helpers ---
    function tvMiniConfig(ticker){ return { symbol:ticker, width:'100%', height:240, locale:'en', dateRange:state.range, colorTheme:'dark', isTransparent:true, autosize:true, largeChartUrl:`https://www.tradingview.com/symbols/${ticker}/`, noTimeScale:false }; }

    function trendSrc(query){
      // Use the official TIMESERIES embed that Google Trends uses internally
      const req={ comparisonItem:[{ keyword: query, geo: state.geo, time: state.trendTime }], category:0 };
      const tz=-new Date().getTimezoneOffset();
      const base='https://trends.google.com/trends/embed/explore/TIMESERIES';
      const params=new URLSearchParams({ hl:'en-US', req: JSON.stringify(req), tz: String(tz) });
      return `${base}?${params.toString()}`;
    }

    function makeRow(stock){
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('div'); left.className='cell sym';
      left.innerHTML=`
        <div><div class="ticker">${stock.ticker}</div><div class="name">${stock.name}</div></div>
        <div class="chips"><span class="chip">${stock.exchange}</span><span class="chip">Trends: ${stock.trendsQuery||stock.name}</span></div>
        <div class="actions"><button class="ghost" data-remove>Remove</button></div>`;

      const mid=document.createElement('div'); mid.className='cell trends';
      const tFrame=document.createElement('iframe'); tFrame.loading='lazy'; tFrame.title=`${stock.trendsQuery||stock.name} â€” Google Trends`; tFrame.src=trendSrc(stock.trendsQuery||stock.name); mid.appendChild(tFrame);

      const right=document.createElement('div'); right.className='cell mini';
      const tvbox=document.createElement('div'); tvbox.className='tvbox'; right.appendChild(tvbox);
      const chips=document.createElement('div'); chips.className='vals'; right.appendChild(chips);

      // Value chip placeholder (kept from earlier design)
      const scoreEl=document.createElement('span'); scoreEl.className='chip score'; scoreEl.textContent='Value â€”'; chips.appendChild(scoreEl);

      // Mount TradingView mini chart lazily
      lazyMountMiniChart(tvbox, `${stock.exchange}:${stock.ticker}`);

      // Compose
      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      table.appendChild(row);

      state.rows.push({ el:row, data:stock, tvbox, tFrame, scoreEl });
    }

    function lazyMountMiniChart(container,symbol){
      const mount=()=>{ if(container.dataset.mounted) return; container.dataset.mounted='1'; addTVMini(container, symbol); };
      const io=new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ mount(); io.disconnect(); } }); },{rootMargin:'200px'});
      io.observe(container);
    }

    function addTVMini(container,symbol){
      const script=document.createElement('script'); script.type='text/javascript'; script.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js'; script.async=true; script.text=JSON.stringify(tvMiniConfig(symbol)); container.appendChild(script);
    }

    // --- Event delegation for Remove button (more reliable) ---
    document.getElementById('table').addEventListener('click', (e)=>{
      const btn=e.target.closest('[data-remove]'); if(!btn) return; const row=btn.closest('.row'); const sym=row.querySelector('.ticker')?.textContent.trim(); row.remove(); state.rows=state.rows.filter(r=>r.data.ticker!==sym);
    });

    // --- Controls ---
    const table=document.getElementById('table');
    document.getElementById('addBtn').addEventListener('click',()=>{
      const input=document.getElementById('add'); const raw=input.value.trim().toUpperCase(); if(!raw) return;
      if(state.rows.some(r=>r.data.ticker===raw)) { input.value=''; return; }
      const item={ ticker:raw, name:raw, exchange:'NASDAQ', trendsQuery:raw };
      makeRow(item); input.value='';
    });

    document.getElementById('range').addEventListener('change',e=>{
      state.range=e.target.value; // re-render each chart widget
      state.rows.forEach(r=>{ r.tvbox.innerHTML=''; r.tvbox.removeAttribute('data-mounted'); lazyMountMiniChart(r.tvbox, `${r.data.exchange}:${r.data.ticker}`); });
    });

    document.getElementById('geo').addEventListener('change',e=>{ state.geo=e.target.value; refreshTrends(); });
    document.getElementById('trendTime').addEventListener('change',e=>{ state.trendTime=e.target.value; refreshTrends(); });

    function refreshTrends(){ state.rows.forEach(r=>{ r.tFrame.src=trendSrc(r.data.trendsQuery||r.data.name); }); }

    // --- Init ---
    WATCHLIST.forEach(makeRow);
  </script>
</body>
</html>
