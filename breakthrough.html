<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BREAKTHROUGH Monitor</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #131a22;
      --panel-2: #0f151c;
      --text: #e6edf3;
      --muted: #a5b1bf;
      --accent: #3ea6ff;
      --good: #18b663;
      --bad: #ff4d4f;
      --chip: #1b2430;
      --border: #243040;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(11,15,20,0.9), rgba(11,15,20,0.6));
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 14px 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; letter-spacing: 0.3px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .control { display: flex; gap: 8px; align-items: center; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    .control label { color: var(--muted); font-size: 12px; }
    select, input[type="text"] { background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; outline: none; }
    button { background: var(--accent); color: #071018; border: none; border-radius: 10px; padding: 8px 12px; font-weight: 700; cursor: pointer; }
    button.ghost { background: transparent; color: var(--accent); border: 1px solid var(--accent); }

    .table {
      max-width: 1300px; margin: 14px auto; border-collapse: separate; border-spacing: 0 10px; padding: 0 8px 24px;
    }
    .row { display: grid; grid-template-columns: 180px minmax(360px, 1fr) minmax(360px, 1fr); gap: 12px; align-items: stretch; }
    .row + .row { margin-top: 12px; }
    .cell { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; min-height: 100px; display: flex; }

    /* Left cell: symbol & quick actions */
    .sym { padding: 12px; display: grid; grid-template-rows: auto 1fr auto; width: 100%; gap: 8px; }
    .ticker { font-size: 18px; font-weight: 800; letter-spacing: 0.5px; }
    .name { color: var(--muted); font-size: 12px; line-height: 1.3; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px; }
    .chip { background: var(--chip); border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; font-size: 11px;}
    .score { font-weight: 800; }
    .score.good { color: var(--good); }
    .score.bad { color: var(--bad); }
    .actions { display: flex; gap: 8px; }

    /* Middle cell: Google Trends */
    .trends { background: var(--panel-2); border-right: 1px solid var(--border); width: 100%; }
    .trends iframe { width: 100%; height: 100%; min-height: 140px; border: 0; }

    /* Right cell: Indicators */
    .indicators { position: relative; width: 100%; background: var(--panel-2); }
    .indicators .tvbox { position: relative; min-height: 160px; }
    .indicators .tvbox.loading::after { content: "Loading TAâ€¦"; position: absolute; inset: 0; display: grid; place-items: center; color: var(--muted); font-size: 12px; }

    /* Modal */
    dialog { border: 1px solid var(--border); border-radius: 14px; background: var(--panel); color: var(--text); width: 420px; }
    dialog::backdrop { background: rgba(0,0,0,0.6); }
    .modal-body { display: grid; gap: 10px; padding: 16px; }
    .field { display: grid; grid-template-columns: 1fr 88px; gap: 10px; align-items: center; }
    .field input[type="number"] { width: 100%; }
    .row-head { display: grid; grid-template-columns: 180px 1fr 1fr; gap: 12px; padding: 0 8px; margin: 10px auto; max-width: 1300px; color: var(--muted); font-size: 12px; }

    .note { max-width: 1300px; margin: 0 auto 18px; padding: 0 16px; color: var(--muted); font-size: 12px; }
    .muted { color: var(--muted); }

    @media (max-width: 1100px) {
      .row, .row-head { grid-template-columns: 1fr; }
      .cell { min-height: 140px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸš€ BREAKTHROUGH Monitor</h1>
      <div class="controls">
        <div class="control">
          <label for="geo">Geo</label>
          <select id="geo">
            <option value="US">US</option>
            <option value="">Worldwide</option>
          </select>
        </div>
        <div class="control">
          <label for="range">Trends range</label>
          <select id="range">
            <option value="today 1-m">Past 30 days</option>
            <option value="now 7-d">Past 7 days</option>
            <option value="today 3-m">Past 90 days</option>
            <option value="today 12-m">Past 12 months</option>
          </select>
        </div>
        <div class="control">
          <label for="add">Add ticker</label>
          <input id="add" type="text" placeholder="e.g. PLTR" />
          <button id="addBtn">Add</button>
        </div>
        <button class="ghost" id="sortBtn">Sort by Value Score</button>
      </div>
    </div>
  </header>

  <div class="row-head">
    <div>Symbol</div>
    <div>Google Trends (sparkline)</div>
    <div>Indicators (TradingView TA + Value Score)</div>
  </div>

  <div class="note">Notes: Middle column uses official Google Trends <code>embed</code> iframes with fully-qualified URLs and URL-encoded queries â€” this fixes prior 404s (<code>today 1-m</code> space is encoded correctly). Right column lazy-loads TradingView's Technical Analysis widget. Value Score is a local (client-side) composite you can tweak per symbol (click <em>Edit</em>). Data persists in <code>localStorage</code>.</div>

  <main class="table" id="table"></main>

  <!-- Value Score editor modal -->
  <dialog id="scoreModal">
    <form method="dialog" class="modal-body">
      <h3 id="scoreTitle" style="margin:0 0 6px">Adjust Value Score</h3>
      <p class="muted" style="margin:0 0 8px">These are simple sliders used in our in-house formula. Tweak and hit Save. (This is a local, manual proxy until we wire live data.)</p>
      <div class="field"><label>Momentum (0-100)</label><input type="number" id="m_momo" min="0" max="100"></div>
      <div class="field"><label>Volume pressure (0-100)</label><input type="number" id="m_vol" min="0" max="100"></div>
      <div class="field"><label>Trend buzz (0-100)</label><input type="number" id="m_trend" min="0" max="100"></div>
      <div class="field"><label>News/catalysts (0-100)</label><input type="number" id="m_news" min="0" max="100"></div>
      <div class="field"><label>Asymmetry (0-100)</label><input type="number" id="m_risk" min="0" max="100"></div>

      <div class="field"><label>Weight: Momentum</label><input type="number" id="w_momo" min="0" max="100"></div>
      <div class="field"><label>Weight: Volume</label><input type="number" id="w_vol" min="0" max="100"></div>
      <div class="field"><label>Weight: Trend</label><input type="number" id="w_trend" min="0" max="100"></div>
      <div class="field"><label>Weight: News</label><input type="number" id="w_news" min="0" max="100"></div>
      <div class="field"><label>Weight: Asym.</label><input type="number" id="w_risk" min="0" max="100"></div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
        <button value="cancel" class="ghost">Cancel</button>
        <button id="saveScoreBtn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ------- CONFIG -------
    // Initial watchlist. You can edit freely. trendsQuery is what we pass to Google Trends.
    const WATCHLIST = [
      { ticker: 'PLTR', name: 'Palantir', exchange: 'NYSE', trendsQuery: 'Palantir' },
      { ticker: 'QSI',  name: 'Quantum-Si', exchange: 'NASDAQ', trendsQuery: 'Quantum-Si' },
      { ticker: 'APLD', name: 'Applied Digital', exchange: 'NASDAQ', trendsQuery: 'Applied Digital' },
      { ticker: 'INOD', name: 'Innodata', exchange: 'NASDAQ', trendsQuery: 'Innodata' },
      { ticker: 'INDI', name: 'indie Semiconductor', exchange: 'NASDAQ', trendsQuery: 'indie Semiconductor' },
      { ticker: 'PATH', name: 'UiPath', exchange: 'NYSE', trendsQuery: 'UiPath' },
      { ticker: 'IRDM', name: 'Iridium', exchange: 'NASDAQ', trendsQuery: 'Iridium (company)' },
      { ticker: 'NVDA', name: 'NVIDIA', exchange: 'NASDAQ', trendsQuery: 'NVIDIA' },
      { ticker: 'TPIC', name: 'TPI Composites', exchange: 'NASDAQ', trendsQuery: 'TPI Composites' },
      { ticker: 'LCID', name: 'Lucid Motors', exchange: 'NASDAQ', trendsQuery: 'Lucid Motors' },
      { ticker: 'MVIS', name: 'MicroVision', exchange: 'NASDAQ', trendsQuery: 'MicroVision' },
    ];

    // Default slider values and weights (our lightweight proxy for your â€œvalue calcâ€ until we hook real data)
    const DEFAULT_MODEL = {
      metrics: { momo: 55, vol: 55, trend: 50, news: 50, risk: 55 },
      weights: { momo: 30, vol: 25, trend: 20, news: 15, risk: 10 }, // total 100
    };

    // ------- STATE -------
    const state = {
      geo: 'US',
      range: 'today 1-m',
      rows: [], // {el, data}
      // Persist per-ticker score model in localStorage
      getModel(ticker) {
        const raw = localStorage.getItem(`bt_model_${ticker}`);
        if (!raw) return structuredClone(DEFAULT_MODEL);
        try { return JSON.parse(raw); } catch { return structuredClone(DEFAULT_MODEL); }
      },
      setModel(ticker, model) {
        localStorage.setItem(`bt_model_${ticker}`, JSON.stringify(model));
      }
    };

    // ------- HELPERS -------
    function trendSrc(query) {
      const base = 'https://trends.google.com/trends/embed/';
      // Fully-qualified URL + encoded query + explicit hl. This avoids prior 404s.
      const q = encodeURIComponent(query);
      const date = encodeURIComponent(state.range); // preserve space as %20
      const geo = state.geo; // '' for worldwide
      return `${base}?q=${q}&geo=${geo}&date=${date}&hl=en-US`;
    }

    function tvWidgetConfig(ticker) {
      // TradingView Technical Analysis widget configuration
      return {
        interval: '1D',
        width: '100%',
        isTransparent: true,
        height: 160,
        symbol: ticker,
        showIntervalTabs: true,
        displayMode: 'single',
        locale: 'en',
        colorTheme: 'dark',
      };
    }

    function calcValueScore(model) {
      const m = model.metrics, w = model.weights;
      const weighted = (m.momo*w.momo + m.vol*w.vol + m.trend*w.trend + m.news*w.news + m.risk*w.risk) / Math.max(1,(w.momo + w.vol + w.trend + w.news + w.risk));
      return Math.round(weighted);
    }

    function scoreClass(score){ return score >= 60 ? 'good' : (score <= 40 ? 'bad' : ''); }

    // ------- RENDER -------
    const table = document.getElementById('table');

    function makeRow(stock){
      const row = document.createElement('div');
      row.className = 'row';

      // Left cell (symbol)
      const left = document.createElement('div');
      left.className = 'cell sym';
      left.innerHTML = `
        <div>
          <div class="ticker">${stock.ticker}</div>
          <div class="name">${stock.name}</div>
        </div>
        <div class="chips">
          <span class="chip">${stock.exchange}</span>
          <span class="chip">Trends: <b>${stock.trendsQuery}</b></span>
        </div>
        <div class="actions">
          <button class="ghost" data-edit>Edit</button>
          <a class="ghost" href="https://www.tradingview.com/symbols/${stock.ticker}" target="_blank" rel="noopener">Open on TV</a>
        </div>`;

      // Middle cell (Google Trends)
      const mid = document.createElement('div');
      mid.className = 'cell trends';
      const iframe = document.createElement('iframe');
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.loading = 'lazy';
      iframe.title = `${stock.trendsQuery} â€“ Google Trends`; 
      iframe.src = trendSrc(stock.trendsQuery);
      mid.appendChild(iframe);

      // Right cell (Indicators: TV TA + Value Score chips)
      const right = document.createElement('div');
      right.className = 'cell indicators';
      const tvbox = document.createElement('div');
      tvbox.className = 'tvbox loading';

      // Score chips container
      const chips = document.createElement('div');
      chips.style.position = 'absolute';
      chips.style.top = '8px';
      chips.style.right = '8px';
      chips.style.display = 'flex';
      chips.style.flexWrap = 'wrap';
      chips.style.gap = '6px';

      const model = state.getModel(stock.ticker);
      const score = calcValueScore(model);
      const scoreEl = document.createElement('span');
      scoreEl.className = `chip score ${scoreClass(score)}`;
      scoreEl.textContent = `Value ${score}`;
      chips.appendChild(scoreEl);

      // Attach containers
      right.appendChild(tvbox);
      right.appendChild(chips);

      // Compose row
      row.appendChild(left);
      row.appendChild(mid);
      row.appendChild(right);

      // Edit handler
      left.querySelector('[data-edit]').addEventListener('click', () => openScoreEditor(stock.ticker));

      // Lazy-load the TradingView widget when visible
      lazyMountTV(tvbox, stock.ticker);

      // Keep references
      table.appendChild(row);
      state.rows.push({ el: row, data: stock, scoreEl, get score(){ return calcValueScore(state.getModel(stock.ticker)); } });
    }

    function lazyMountTV(container, ticker){
      const mount = () => {
        if (container.dataset.mounted) return;
        container.dataset.mounted = '1';
        addTVWidget(container, ticker);
      };
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => { if(e.isIntersecting) { mount(); io.disconnect(); } });
      }, { rootMargin: '200px' });
      io.observe(container);
    }

    function addTVWidget(container, ticker){
      // Remove loading state once the iframe inserts
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js';
      script.async = true;
      script.text = JSON.stringify(tvWidgetConfig(ticker));
      container.appendChild(script);
      // Clear loading label after a short grace
      setTimeout(() => container.classList.remove('loading'), 1200);
    }

    // ------- SCORE EDITOR -------
    const modal = document.getElementById('scoreModal');
    const title = document.getElementById('scoreTitle');
    const inputs = ['momo','vol','trend','news','risk'].reduce((acc,k)=>{ acc[k] = document.getElementById('m_'+k); return acc; },{});
    const weights = ['momo','vol','trend','news','risk'].reduce((acc,k)=>{ acc[k] = document.getElementById('w_'+k); return acc; },{});
    let editingTicker = null;

    function openScoreEditor(ticker){
      editingTicker = ticker;
      const m = state.getModel(ticker);
      title.textContent = `Adjust Value Score â€” ${ticker}`;
      inputs.momo.value = m.metrics.momo; inputs.vol.value = m.metrics.vol; inputs.trend.value = m.metrics.trend; inputs.news.value = m.metrics.news; inputs.risk.value = m.metrics.risk;
      weights.momo.value = m.weights.momo; weights.vol.value = m.weights.vol; weights.trend.value = m.weights.trend; weights.news.value = m.weights.news; weights.risk.value = m.weights.risk;
      modal.showModal();
    }

    document.getElementById('saveScoreBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if(!editingTicker) return modal.close();
      const model = {
        metrics: {
          momo: clamp(+inputs.momo.value),
          vol: clamp(+inputs.vol.value),
          trend: clamp(+inputs.trend.value),
          news: clamp(+inputs.news.value),
          risk: clamp(+inputs.risk.value),
        },
        weights: {
          momo: clamp(+weights.momo.value),
          vol: clamp(+weights.vol.value),
          trend: clamp(+weights.trend.value),
          news: clamp(+weights.news.value),
          risk: clamp(+weights.risk.value),
        }
      };
      state.setModel(editingTicker, model);
      // Update chip in the corresponding row
      const row = state.rows.find(r => r.data.ticker === editingTicker);
      if (row) {
        const newScore = calcValueScore(model);
        row.scoreEl.textContent = `Value ${newScore}`;
        row.scoreEl.className = `chip score ${scoreClass(newScore)}`;
      }
      editingTicker = null;
      modal.close();
    });

    function clamp(n){ return Math.max(0, Math.min(100, Number.isFinite(n) ? n : 0)); }

    // ------- CONTROLS -------
    const geoSel = document.getElementById('geo');
    const rangeSel = document.getElementById('range');

    geoSel.addEventListener('change', () => { state.geo = geoSel.value; refreshTrends(); });
    rangeSel.addEventListener('change', () => { state.range = rangeSel.value; refreshTrends(); });

    function refreshTrends(){
      document.querySelectorAll('.trends iframe').forEach((f, idx) => {
        const stock = state.rows[idx].data;
        f.src = trendSrc(stock.trendsQuery); // rebuild URL with proper encoding
      });
    }

    // Add ticker control
    document.getElementById('addBtn').addEventListener('click', () => {
      const input = document.getElementById('add');
      const raw = input.value.trim().toUpperCase();
      if(!raw) return;
      if(state.rows.some(r => r.data.ticker === raw)) { input.value=''; return; }
      // naive defaults for new additions
      const item = { ticker: raw, name: raw, exchange: 'US', trendsQuery: raw };
      makeRow(item);
      input.value = '';
    });

    // Sort by Value Score
    document.getElementById('sortBtn').addEventListener('click', () => {
      state.rows.sort((a,b)=> b.score - a.score);
      state.rows.forEach(r => table.appendChild(r.el));
    });

    // ------- INIT -------
    WATCHLIST.forEach(makeRow);
  </script>
</body>
</html>
