<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stocks + Google Trends Dashboard</title>
  <style>
    :root { --bg:#0b0f14; --panel:#111826; --border:#1c2633; --text:#e6eef7; --muted:#9fb3c8; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:20px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:18px}
    .container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:16px;align-items:start}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .card h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .chart{height:400px}
    .trend{height:360px}
    .placeholder{height:120px;display:grid;place-items:center;color:var(--muted);border:1px dashed var(--border);border-radius:12px;background:transparent}
    table{color:var(--text)}
    th,td{border-color:var(--border)}
    @media (max-width:980px){.container{grid-template-columns:1fr}.chart,.trend{height:300px}}
  </style>
</head>
<body>
  <header>
    <h1>Watchlist — Stocks (left) • Google Trends (middle) • Breakout Radar (right)</h1>
  </header>

  <div id="grid" class="container"></div>

  <!-- Load Google Trends embed loader BEFORE our script -->
  <script src="https://ssl.gstatic.com/trends_nrtr/3343_RC01/embed_loader.js"></script>
  <script>
    /* =============================
       CONFIG — EDIT THIS ONLY
       ============================= */
    const WATCHLIST = [
      { symbol: "NASDAQ:MVIS", name: "MicroVision (MVIS)", trendTerm: "MicroVision" },
      { symbol: "NASDAQ:QSI",  name: "Quantum-Si (QSI)",   trendTerm: "Quantum-Si" },
      { symbol: "NASDAQ:REKR", name: "Rekor Systems (REKR)", trendTerm: "Rekor Systems" }
    ];
    const TRENDS_GEO = "";            // "" = Worldwide
    const TRENDS_TIME = "today 3-m";  // last 3 months

    // Breakout radar settings (Right column)
    const BENCHMARK = "QQQ";         // used for short-term RS calc (10 trading days)
    const RS_LOOKBACK = 10;           // days
    const AVG_VOL_WINDOW = 20;        // sessions
    const HIGH_LOOKBACK = 30;         // sessions for near-high check
    const MA50_WINDOW = 50;
    const MA200_WINDOW = 200;

    // Thresholds for green checks
    const THRESHOLDS = {
      volVsAvg: 2.0,              // >=200%
      nearHighPct: -0.05,         // within 5% of 30d high (price/high - 1)
      rsOutperformance: 0.02      // +2% vs benchmark over RS_LOOKBACK
    };

    /* =============================
       HELPERS
       ============================= */
    const grid = document.getElementById('grid');

    function renderTradingView(container, symbol){
      const wrap=document.createElement('div');
      wrap.className='tradingview-widget-container';
      const widget=document.createElement('div');
      widget.className='tradingview-widget-container__widget';
      wrap.appendChild(widget);
      const s=document.createElement('script');
      s.type='text/javascript';
      s.src='https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      s.async=true;
      s.innerHTML=JSON.stringify({
        symbols:[[symbol+"|1D"]],chartOnly:false,width:"100%",height:"100%",locale:"en",autosize:true,dateRange:"12M",showVolume:true,showMA:true
      });
      wrap.appendChild(s);
      container.appendChild(wrap);
    }

    function renderTrends(container, keyword){
      try{
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidgetTo==='function'){
          trends.embed.renderExploreWidgetTo(
            container,
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery: `q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          );
          return;
        }
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidget==='function'){
          const before = document.body.querySelectorAll('iframe').length;
          trends.embed.renderExploreWidget(
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery: `q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          );
          const observer=new MutationObserver(()=>{
            const iframes=[...document.querySelectorAll('iframe')];
            if (iframes.length>before){
              const iframe=iframes[iframes.length-1];
              container.appendChild(iframe); observer.disconnect();
            }
          });
          observer.observe(document.body,{childList:true,subtree:true});
          return;
        }
        const src = `https://trends.google.com:443/trends/embed/?q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`;
        const iframe=document.createElement('iframe');
        iframe.src=src; iframe.width='100%'; iframe.height='100%'; iframe.frameBorder='0';
        container.appendChild(iframe);
      }catch(e){
        const err=document.createElement('div'); err.style.color='#f99'; err.textContent='Trends embed error: '+e.message; container.appendChild(err);
      }
    }

    /* =============================
       DATA FETCHERS (Breakout Radar)
       ============================= */
    async function yahooChart(symbol, range='1y', interval='1d'){
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}&includePrePost=false&events=div%7Csplit`;
      const r = await fetch(url); if(!r.ok) throw new Error('chart fetch failed');
      return r.json();
    }
    async function yahooQuote(symbol){
      const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbol)}`;
      const r = await fetch(url); if(!r.ok) throw new Error('quote fetch failed');
      return r.json();
    }
    async function yahooEarnings(symbol){
      try{
        const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(symbol)}?modules=calendarEvents`;
        const r = await fetch(url); if(!r.ok) throw new Error('earnings fetch failed');
        return r.json();
      }catch(e){ return null; }
    }

    function pctFmt(x){ return (x*100).toFixed(1)+'%'; }
    function signIcon(ok){ return ok ? '✅' : '—'; }

    async function populateRadar(rowIdx, symbol){
      try{
        const [chart, quote, benchChart] = await Promise.all([
          yahooChart(symbol, '1y', '1d'),
          yahooQuote(symbol),
          yahooChart(BENCHMARK, '6mo', '1d')
        ]);
        const c = chart.chart.result[0];
        const closes = c.indicators.quote[0].close.filter(v=>v!=null);
        const volumes = c.indicators.quote[0].volume.filter(v=>v!=null);
        const price = closes[closes.length-1];

        // Volume vs 20d avg
        const recentVol = volumes[volumes.length-1];
        const avgVol = volumes.slice(-AVG_VOL_WINDOW).reduce((a,b)=>a+b,0)/Math.min(AVG_VOL_WINDOW, volumes.length);
        const volVs = recentVol/avgVol;
        document.getElementById(`vavg-${rowIdx}`).textContent = volVs.toFixed(2)+'x';
        document.getElementById(`vavg-s-${rowIdx}`).textContent = signIcon(volVs>=THRESHOLDS.volVsAvg);

        // RS vs benchmark over RS_LOOKBACK
        const bc = benchChart.chart.result[0].indicators.quote[0].close.filter(v=>v!=null);
        const p0 = closes[closes.length-1-RS_LOOKBACK];
        const b0 = bc[bc.length-1-RS_LOOKBACK];
        const rs = (price/p0) / (bc[bc.length-1]/b0) - 1; // relative outperformance
        document.getElementById(`rs-${rowIdx}`).textContent = pctFmt(rs);
        document.getElementById(`rs-s-${rowIdx}`).textContent = signIcon(rs>=THRESHOLDS.rsOutperformance);

        // Price vs 30d high
        const windowCloses = closes.slice(-HIGH_LOOKBACK);
        const high = Math.max(...windowCloses);
        const nearHigh = price/high - 1; // negative number if below high
        document.getElementById(`phigh-${rowIdx}`).textContent = pctFmt(nearHigh);
        document.getElementById(`phigh-s-${rowIdx}`).textContent = signIcon(nearHigh>=THRESHOLDS.nearHighPct);

        // MAs
        const ma = (arr, n) => arr.slice(-n).reduce((a,b)=>a+b,0)/Math.min(n, arr.length);
        const ma50 = ma(closes, MA50_WINDOW);
        const ma200 = ma(closes, MA200_WINDOW);
        const above50 = price>ma50; const above200 = price>ma200;
        document.getElementById(`ma-${rowIdx}`).textContent = `${above50? 'Above' : 'Below'} 50d / ${above200? 'Above':'Below'} 200d`;
        document.getElementById(`ma-s-${rowIdx}`).textContent = signIcon(above50 && above200);

        // Earnings date (best-effort)
        try{
          const e = await yahooEarnings(symbol);
          const ev = e?.quoteSummary?.result?.[0]?.calendarEvents?.earnings?.earningsDate?.[0]?.raw;
          if(ev){
            const dt = new Date(ev*1000);
            document.getElementById(`earn-${rowIdx}`).textContent = dt.toISOString().slice(0,10);
          }
        }catch(_){/* ignore */}
      }catch(err){
        const cells = ['vavg','vavg-s','rs','rs-s','phigh','phigh-s','ma','ma-s','earn'];
        cells.forEach(id=>{ const el=document.getElementById(`${id}-${rowIdx}`); if(el) el.textContent = '—'; });
        console.error('Radar error for', symbol, err);
      }
    }

    /* =============================
       BUILD GRID ROWS
       ============================= */
    WATCHLIST.forEach((item, idx)=>{
      const left=document.createElement('div'); left.className='card';
      const hL=document.createElement('h2'); hL.textContent=`${item.name} — Price & Chart`;
      const cL=document.createElement('div'); cL.className='chart';
      left.appendChild(hL); left.appendChild(cL);

      const mid=document.createElement('div'); mid.className='card';
      const hM=document.createElement('h2'); hM.textContent=`Google Trends — “${item.trendTerm}” (3 months, Worldwide)`;
      const cM=document.createElement('div'); cM.className='trend'; cM.id=`trend-${idx}`;
      mid.appendChild(hM); mid.appendChild(cM);

      const right=document.createElement('div'); right.className='card';
      const hR=document.createElement('h2'); hR.textContent='Breakout Radar';
      const tbl=document.createElement('table');
      tbl.style.width='100%'; tbl.style.borderCollapse='collapse'; tbl.style.fontSize='12px';
      tbl.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:left;padding:6px 4px;border-bottom:1px solid var(--border);">Metric</th>
            <th style="text-align:right;padding:6px 4px;border-bottom:1px solid var(--border);">Value</th>
            <th style="text-align:center;padding:6px 4px;border-bottom:1px solid var(--border);">Signal</th>
          </tr>
        </thead>
        <tbody>
          <tr><td style="padding:6px 4px;">Volume vs 20d Avg</td><td id="vavg-${idx}" style="text-align:right;padding:6px 4px;">—</td><td id="vavg-s-${idx}" style="text-align:center;">—</td></tr>
          <tr><td style="padding:6px 4px;">RS vs ${BENCHMARK} (${RS_LOOKBACK}d)</td><td id="rs-${idx}" style="text-align:right;padding:6px 4px;">—</td><td id="rs-s-${idx}" style="text-align:center;">—</td></tr>
          <tr><td style="padding:6px 4px;">Price vs 30d High</td><td id="phigh-${idx}" style="text-align:right;padding:6px 4px;">—</td><td id="phigh-s-${idx}" style="text-align:center;">—</td></tr>
          <tr><td style="padding:6px 4px;">Above 50d / 200d MA</td><td id="ma-${idx}" style="text-align:right;padding:6px 4px;">—</td><td id="ma-s-${idx}" style="text-align:center;">—</td></tr>
          <tr><td style="padding:6px 4px;">Next Earnings</td><td id="earn-${idx}" style="text-align:right;padding:6px 4px;">—</td><td style="text-align:center;">—</td></tr>
        </tbody>`;
      right.appendChild(hR); right.appendChild(tbl);

      grid.appendChild(left); grid.appendChild(mid); grid.appendChild(right);

      // Render widgets
      renderTradingView(cL, item.symbol);
      renderTrends(cM, item.trendTerm);
      populateRadar(idx, item.symbol);
    });
  </script>
</body>
</html>
