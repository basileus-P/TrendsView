<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stocks + Google Trends Dashboard</title>
  <style>
    :root {
      --bg:#0b0f14; --panel:#111826; --border:#1c2633; --text:#e6eef7; --muted:#9fb3c8;
      --good:#19c37d; --bad:#d66; --warn:#d6a019; --accent:#8fb6ff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:16px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar input{background:#0e1522;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}
    .toolbar button{background:#152235;border:1px solid var(--border);color:#e6eef7;padding:8px 12px;border-radius:10px;cursor:pointer}
    .toolbar button:hover{filter:brightness(1.1)}
    #last-updated{color:var(--muted);font-size:12px}

    .container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:16px;align-items:start}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    .card h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px;padding-right:36px}
    .remove-btn{position:absolute;top:10px;right:10px;background:#1b293d;border:1px solid var(--border);color:#d77;padding:4px 8px;border-radius:8px;font-size:12px;cursor:pointer}
    .remove-btn:hover{filter:brightness(1.1)}

    .chart{height:400px}
    .trend{height:360px}
    table{width:100%;border-collapse:collapse;color:var(--text)}
    th,td{border-color:var(--border);padding:6px 4px}
    th{border-bottom:1px solid var(--border);text-align:left}
    td.val{text-align:right}
    td.sig{text-align:center;width:60px}
    .ok{color:var(--good);font-weight:600}
    .ko{color:var(--muted)}
    .warn{color:var(--warn)}
    .spark{height:44px}
    .spark svg{width:100%;height:44px;display:block}
    .spark .line{fill:none;stroke:var(--accent);stroke-width:2}
    .spark .fill{fill:rgba(143,182,255,0.12);stroke:none}
    .spark .axis{stroke:#233046;stroke-width:1}

    .strength-badge{position:absolute;top:10px;left:10px;background:#0e1522;border:1px solid var(--border);padding:4px 8px;border-radius:8px;font-size:12px;color:var(--muted)}
    .strength-badge strong{color:#fff}
    .news{margin-top:10px}
    .news h3{margin:8px 0 4px;font-size:12px;color:var(--muted)}
    .news ul{list-style:none;padding:0;margin:0}
    .news li{margin:6px 0}
    .news a{color:var(--accent);text-decoration:none}
    .news a:hover{text-decoration:underline}
    .news time{color:var(--muted);font-size:11px;margin-left:6px}

    @media (max-width:980px){
      .container{grid-template-columns:1fr}
      .chart,.trend{height:300px}
    }
  </style>
</head>
<body>
  <header>
    <h1>Stocks (left) • Google Trends (middle) • Breakout Radar (right)</h1>
    <div class="toolbar">
      <input id="in-symbol" placeholder="EXCHANGE:TICKER (e.g., NASDAQ:MVIS)" size="28" />
      <input id="in-name" placeholder="Display name" size="20" />
      <input id="in-trend" placeholder="Google Trends term" size="20" />
      <button id="btn-add">Add</button>
      <button id="btn-reset">Reset defaults</button>
      <button id="btn-refresh">Refresh Now</button>
      <span id="last-updated"></span>
    </div>
  </header>

  <div id="grid" class="container"></div>

  <!-- Google Trends embed loader -->
  <script src="https://ssl.gstatic.com/trends_nrtr/3343_RC01/embed_loader.js"></script>
  <script>
    /* ============== CONFIG ============== */
    const DEFAULT_WATCHLIST = [
      { symbol: "NASDAQ:MVIS", name: "MicroVision (MVIS)", trendTerm: "MicroVision" },
      { symbol: "NASDAQ:QSI",  name: "Quantum-Si (QSI)",   trendTerm: "Quantum-Si" },
      { symbol: "NASDAQ:REKR", name: "Rekor Systems (REKR)", trendTerm: "Rekor Systems" }
    ];
    const STORAGE_KEY = 'WATCHLIST_V2'; // bumped since we sort order now
    const TRENDS_GEO = "";             // Worldwide
    const TRENDS_TIME = "today 1-m";   // last 1 month (per your request)

    // Breakout metric params
    const BENCHMARK = "QQQ";  // for RS calc
    const RS_LOOKBACK = 10;
    const AVG_VOL_WINDOW = 20;
    const HIGH_LOOKBACK = 30;
    const MA50_WINDOW = 50;
    const MA200_WINDOW = 200;

    // thresholds (you can tune)
    const THRESHOLDS = {
      volVsAvg: 1.5,          // >= 1.5x avg volume
      nearHighPct: -0.10,     // within 10% of 30d high
      rsOutperformance: 0.01  // RS >= +1% vs benchmark
    };

    // Strength score weights (sum ~= 1.0)
    const SCORE_WEIGHTS = {
      volVsAvg: 0.35,
      rs:       0.25,
      nearHigh: 0.25,
      maStack:  0.15
    };

    // Normalization caps (what counts as “full score”)
    const SCORE_CAPS = {
      volVsAvg: 3.0,   // 3x volume saturates the vol component
      rs:       0.05,  // +5% outperformance over 10d = full score
      nearHigh: 0.10   // within 10% of 30d high = full score
    };

    // auto-refresh timers
    const REFRESH_MS = 5 * 60 * 1000;        // 5 minutes (radar)
    const NEWS_REFRESH_MS = 15 * 60 * 1000;  // 15 minutes (news)

    /* ============== STORAGE ============== */
    function getWatchlist(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return DEFAULT_WATCHLIST.slice();
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr) || !arr.length) return DEFAULT_WATCHLIST.slice();
        return arr;
      }catch{ return DEFAULT_WATCHLIST.slice(); }
    }
    function setWatchlist(arr){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch{}
    }

    /* ============== UI HELPERS ============== */
    const grid = document.getElementById('grid');

    function renderTradingView(container, symbol){
      const wrap=document.createElement('div');
      wrap.className='tradingview-widget-container';
      const widget=document.createElement('div');
      widget.className='tradingview-widget-container__widget';
      wrap.appendChild(widget);
      const s=document.createElement('script');
      s.type='text/javascript';
      s.src='https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      s.async=true;
      s.innerHTML=JSON.stringify({
        symbols:[[symbol+"|1D"]],chartOnly:false,width:"100%",height:"100%",locale:"en",autosize:true,dateRange:"12M",showVolume:true,showMA:true
      });
      wrap.appendChild(s);
      container.appendChild(wrap);
    }

    function renderTrends(container, keyword){
      try{
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidgetTo==='function'){
          trends.embed.renderExploreWidgetTo(
            container,
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery: `q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          ); return;
        }
        const src = `https://trends.google.com:443/trends/embed/?q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`;
        const iframe=document.createElement('iframe');
        iframe.src=src; iframe.width='100%'; iframe.height='100%'; iframe.frameBorder='0';
        container.appendChild(iframe);
      }catch(e){
        const err=document.createElement('div'); err.style.color='#f99'; err.textContent='Trends embed error: '+e.message; container.appendChild(err);
      }
    }

    /* ============== RESILIENT CORS PROXIES (Yahoo + RSS) ============== */
    async function getRaw(url) {
      const candidates = [
        'https://cors.isomorphic-git.org/' + url,
        'https://corsproxy.io/?' + encodeURIComponent(url),
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
      ];
      const addBuster = u => u + (u.includes('?') ? '&' : '?') + 'noCache=' + Date.now();
      let lastErr;
      for (const prox of candidates) {
        try {
          const r = await fetch(addBuster(prox));
          if (!r.ok) throw new Error('proxy status ' + r.status);
          return await r.text();
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('all proxies failed');
    }
    async function getJSON(url) {
      const txt = await getRaw(url);
      try { return JSON.parse(txt); }
      catch (e) { throw new Error('bad JSON: ' + txt.slice(0,120)); }
    }
    function yTicker(sym){ return String(sym || '').split(':').pop().trim().toUpperCase(); }
    async function yahooChart(ticker, range='1y', interval='1d'){
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=${range}&interval=${interval}&includePrePost=false&events=div%7Csplit`;
      return getJSON(url);
    }
    async function yahooEarnings(ticker){
      const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=calendarEvents`;
      return getJSON(url);
    }

    /* ============== MINI SPARKLINE ============== */
    function drawSparkline(el, series){
      const W = el.clientWidth || 240, H = 44, P = 2;
      const n = series.length;
      const min = Math.min(...series), max = Math.max(...series);
      const x = i => P + (W-2*P) * (i/(n-1 || 1));
      const y = v => (max===min) ? H/2 : (H - P - (H-2*P) * ((v - min) / (max - min)));
      let d = '';
      series.forEach((v,i)=>{ d += (i? 'L':'M') + x(i) + ',' + y(v); });
      const fill = `${d} L ${x(n-1)},${H-P} L ${x(0)},${H-P} Z`;
      el.innerHTML = `
        <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
          <path class="fill" d="${fill}"></path>
          <path class="line" d="${d}"></path>
          <line class="axis" x1="0" y1="${H-P}" x2="${W}" y2="${H-P}"></line>
        </svg>`;
    }

    /* ============== METRICS + STRENGTH COMPUTATION ============== */
    function sma(arr,n){ const seg=arr.slice(-n); return seg.reduce((a,b)=>a+b,0)/Math.max(1,seg.length); }
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

    function computeStrength(parts){
      // Normalize to 0..1 and weight
      const volNorm = clamp(parts.volVsAvg / SCORE_CAPS.volVsAvg, 0, 1);
      const rsNorm  = clamp(parts.rs / SCORE_CAPS.rs, 0, 1);
      const near    = Math.max(0, -parts.nearHigh); // positive “distance below high”
      const nhNorm  = clamp(1 - (near / SCORE_CAPS.nearHigh), 0, 1); // closer to high => higher score
      const maNorm  = (parts.above50 ? 0.5 : 0) + (parts.above200 ? 0.5 : 0);

      const score01 =
        volNorm   * SCORE_WEIGHTS.volVsAvg +
        rsNorm    * SCORE_WEIGHTS.rs +
        nhNorm    * SCORE_WEIGHTS.nearHigh +
        maNorm    * SCORE_WEIGHTS.maStack;

      return Math.round(score01 * 100);
    }

    async function fetchBenchmarkCloses(){
      const b = await yahooChart(BENCHMARK, '6mo', '1d');
      return (b?.chart?.result?.[0]?.indicators?.quote?.[0]?.close || []).filter(v=>v!=null);
    }

    async function computeMetricsFor(symbol, benchCloses){
      const t = yTicker(symbol);
      const ch = await yahooChart(t, '1y', '1d');
      const c = ch?.chart?.result?.[0];
      const q = c?.indicators?.quote?.[0];
      const closes  = (q?.close  || []).filter(v=>v!=null);
      const volumes = (q?.volume || []).filter(v=>v!=null);
      if (!closes.length || !volumes.length) throw new Error('no data for '+t);

      const price = closes[closes.length-1];

      // Volume vs 20d avg
      const recentVol = volumes[volumes.length-1];
      const avgVol = volumes.slice(-AVG_VOL_WINDOW).reduce((a,b)=>a+b,0)/Math.max(1, Math.min(AVG_VOL_WINDOW, volumes.length));
      const volVsAvg = recentVol / (avgVol || 1);

      // RS vs benchmark
      const bc = benchCloses;
      const p0 = closes[Math.max(0, closes.length-1-RS_LOOKBACK)];
      const b0 = bc[Math.max(0, bc.length-1-RS_LOOKBACK)];
      const rs = (price/p0) / ((bc[bc.length-1]||p0)/(b0||bc[0]||1)) - 1;

      // Price vs 30d high
      const windowCloses = closes.slice(-HIGH_LOOKBACK);
      const high = Math.max(...windowCloses);
      const nearHigh = price/high - 1; // negative if under the high

      // MAs
      const ma50  = sma(closes, MA50_WINDOW);
      const ma200 = sma(closes, MA200_WINDOW);
      const above50 = price > ma50, above200 = price > ma200;

      // Strength
      const strength = computeStrength({ volVsAvg, rs, nearHigh, above50, above200 });

      return {
        ticker: t, closes, volumes, price,
        volVsAvg, rs, nearHigh, above50, above200,
        strength
      };
    }

    /* ============== NEWS (Google News RSS) ============== */
    function cleanNameForQuery(name){ return String(name || '').replace(/\(.*?\)/g,'').trim(); }
    function relTime(d){
      const t = new Date(d).getTime(); if(!isFinite(t)) return '';
      const mins = Math.max(1, Math.round((Date.now() - t)/60000));
      if (mins < 60) return `${mins}m`; const hrs = Math.round(mins/60);
      if (hrs < 24) return `${hrs}h`; return `${Math.round(hrs/24)}d`;
    }
    async function fetchNewsItems(query){
      const url = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
      const xmlText = await getRaw(url);
      const doc = new DOMParser().parseFromString(xmlText, "text/xml");
      const items = [...doc.getElementsByTagName('item')].slice(0,3).map(node => {
        const title = node.getElementsByTagName('title')[0]?.textContent || '';
        const link = node.getElementsByTagName('link')[0]?.textContent || '#';
        const pub  = node.getElementsByTagName('pubDate')[0]?.textContent || '';
        const source = node.getElementsByTagName('source')[0]?.textContent || '';
        return { title, link, pub, source };
      });
      return items;
    }
    function renderNewsList(container, items){
      if(!container) return;
      if(!items?.length){
        container.innerHTML = `<div class="news"><h3>Latest News</h3><div style="color:var(--muted)">—</div></div>`;
        return;
      }
      container.innerHTML = `
        <div class="news">
          <h3>Latest News</h3>
          <ul>
            ${items.map(it => `
              <li>
                <a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.title}</a>
                ${it.source ? ` <span style="color:var(--muted);font-size:11px">(${it.source})</span>` : ''}
                ${it.pub ? `<time>· ${relTime(it.pub)}</time>` : ''}
              </li>
            `).join('')}
          </ul>
        </div>`;
    }
    async function populateNews(rowIdx, item){
      const tkr = yTicker(item.symbol);
      const name = cleanNameForQuery(item.name);
      const query = `${tkr} stock OR ${name} stock`;
      const mount = document.getElementById(`news-${rowIdx}`);
      try{
        const items = await fetchNewsItems(query);
        renderNewsList(mount, items);
      }catch(e){
        renderNewsList(mount, []);
        console.error('News error', item, e);
      }
    }

    /* ============== BUILD (SORTED BY STRENGTH) ============== */
    function buildRow(item, idx, metrics){
      const left=document.createElement('div'); left.className='card';
      const hL=document.createElement('h2'); hL.textContent=`${item.name} — Price & Chart`;
      const cL=document.createElement('div'); cL.className='chart';
      left.appendChild(hL); left.appendChild(cL);

      const mid=document.createElement('div'); mid.className='card';
      const hM=document.createElement('h2'); hM.textContent=`Google Trends — “${item.trendTerm}” (1 month, Worldwide)`;
      const cM=document.createElement('div'); cM.className='trend'; cM.id=`trend-${idx}`;
      mid.appendChild(hM); mid.appendChild(cM);

      const right=document.createElement('div'); right.className='card';
      const strength=document.createElement('div'); strength.className='strength-badge';
      strength.innerHTML = `Strength: <strong>${metrics.strength}</strong>`;
      const hR=document.createElement('h2'); hR.textContent='Breakout Radar';
      const remove=document.createElement('button'); remove.className='remove-btn'; remove.textContent='Remove';
      remove.addEventListener('click',()=>{ removeStockByName(item.name); });

      const tbl=document.createElement('table');
      tbl.innerHTML = `
        <thead>
          <tr><th>Metric</th><th class="val">Value</th><th class="sig">Signal</th></tr>
        </thead>
        <tbody>
          <tr><td>Volume vs 20d Avg</td><td id="vavg-${idx}" class="val">—</td><td id="vavg-s-${idx}" class="sig">—</td></tr>
          <tr><td>RS vs ${BENCHMARK} (${RS_LOOKBACK}d)</td><td id="rs-${idx}" class="val">—</td><td id="rs-s-${idx}" class="sig">—</td></tr>
          <tr><td>Price vs 30d High</td><td id="phigh-${idx}" class="val">—</td><td id="phigh-s-${idx}" class="sig">—</td></tr>
          <tr><td>Above 50d / 200d MA</td><td id="ma-${idx}" class="val">—</td><td id="ma-s-${idx}" class="sig">—</td></tr>
          <tr><td>Next Earnings</td><td id="earn-${idx}" class="val">—</td><td class="sig">—</td></tr>
          <tr><td>Trend (30 bars)</td><td colspan="2"><div id="spark-${idx}" class="spark"></div></td></tr>
        </tbody>`;

      right.appendChild(strength); right.appendChild(hR); right.appendChild(remove); right.appendChild(tbl);

      // News container
      const newsBox = document.createElement('div');
      newsBox.id = `news-${idx}`;
      newsBox.className = 'news';
      right.appendChild(newsBox);

      grid.appendChild(left); grid.appendChild(mid); grid.appendChild(right);

      renderTradingView(cL, item.symbol);
      renderTrends(cM, item.trendTerm);

      // Fill radar from provided metrics (no re-fetch)
      const closes = metrics.closes;
      const price  = metrics.price;
      const vCell = document.getElementById(`vavg-${idx}`), vSig = document.getElementById(`vavg-s-${idx}`);
      const rCell = document.getElementById(`rs-${idx}`),   rSig = document.getElementById(`rs-s-${idx}`);
      const hCell = document.getElementById(`phigh-${idx}`), hSig = document.getElementById(`phigh-s-${idx}`);
      const mCell = document.getElementById(`ma-${idx}`),    mSig = document.getElementById(`ma-s-${idx}`);

      // sparkline
      drawSparkline(document.getElementById(`spark-${idx}`), closes.slice(-30));

      // volume
      vCell.textContent = metrics.volVsAvg.toFixed(2)+'x';
      setSig(vCell, vSig, metrics.volVsAvg >= THRESHOLDS.volVsAvg);

      // RS
      rCell.textContent = (metrics.rs*100).toFixed(1)+'%';
      setSig(rCell, rSig, metrics.rs >= THRESHOLDS.rsOutperformance);

      // 30d high proximity
      hCell.textContent = (metrics.nearHigh*100).toFixed(1)+'%';
      setSig(hCell, hSig, metrics.nearHigh >= THRESHOLDS.nearHighPct);

      // MA stack
      mCell.textContent = `${metrics.above50?'Above':'Below'} 50d / ${metrics.above200?'Above':'Below'} 200d`;
      setSig(mCell, mSig, metrics.above50 && metrics.above200);

      // earnings (best-effort async)
      (async ()=>{
        try{
          const ej = await yahooEarnings(metrics.ticker);
          const raw = ej?.quoteSummary?.result?.[0]?.calendarEvents?.earnings?.earningsDate?.[0]?.raw;
          document.getElementById(`earn-${idx}`).textContent = raw ? new Date(raw*1000).toISOString().slice(0,10) : '—';
        }catch{ document.getElementById(`earn-${idx}`).textContent = '—'; }
      })();

      // news
      populateNews(idx, item);
    }

    function removeStockByName(name){
      const list = getWatchlist();
      const idx = list.findIndex(x => x.name === name);
      if(idx>=0){ list.splice(idx,1); setWatchlist(list); renderAllSorted(); }
    }

    function updateTimestamp(){
      const ts = new Date().toLocaleTimeString();
      const el = document.getElementById('last-updated');
      if (!el) return;
      el.textContent = `Last updated: ${ts}`;
      el.style.color = 'var(--good)';
      setTimeout(()=>{ el.style.color='var(--muted)'; }, 1500);
    }

    async function buildSortedMetrics(list){
      const benchCloses = await fetchBenchmarkCloses();
      const results = [];
      for (const it of list){
        try{
          const m = await computeMetricsFor(it.symbol, benchCloses);
          results.push({ item: it, metrics: m });
        }catch(e){
          console.error('metrics error', it, e);
          // still push with minimal metrics so it renders
          results.push({ item: it, metrics: { strength: 0, closes: [], price: 0, volVsAvg:0, rs:0, nearHigh:-1, above50:false, above200:false, ticker:yTicker(it.symbol) } });
        }
      }
      // sort descending by strength
      results.sort((a,b)=> b.metrics.strength - a.metrics.strength);
      return results;
    }

    async function renderAllSorted(){
      grid.innerHTML='';

      const list = getWatchlist();
      const results = await buildSortedMetrics(list);

      // Rebuild grid in sorted order
      results.forEach((res, i) => buildRow(res.item, i, res.metrics));
      updateTimestamp();
    }

    function addStock(){
      const s = document.getElementById('in-symbol').value.trim();
      const n = document.getElementById('in-name').value.trim() || s;
      const t = document.getElementById('in-trend').value.trim() || n;
      if(!s){ alert('Enter symbol in EXCHANGE:TICKER format (e.g., NASDAQ:MVIS)'); return; }
      const list = getWatchlist(); list.push({ symbol:s, name:n, trendTerm:t }); setWatchlist(list);
      renderAllSorted();
      document.getElementById('in-symbol').value=''; document.getElementById('in-name').value=''; document.getElementById('in-trend').value='';
    }

    function resetDefaults(){ setWatchlist(DEFAULT_WATCHLIST.slice()); renderAllSorted(); }

    function refreshNow(){
      // Full recompute + resort
      renderAllSorted();
    }

    document.getElementById('btn-add').addEventListener('click', addStock);
    document.getElementById('btn-reset').addEventListener('click', resetDefaults);
    document.getElementById('btn-refresh').addEventListener('click', refreshNow);

    // Initial render (sorted)
    renderAllSorted();

    // Auto-refresh radar + resort every 5 minutes
    setInterval(renderAllSorted, REFRESH_MS);

    // Auto-refresh news every 15 minutes (runs inside render too, but keep it in case of mid-cycle)
    setInterval(async () => {
      const list = getWatchlist();
      list.forEach((it, i)=> populateNews(i, it));
    }, NEWS_REFRESH_MS);
  </script>
</body>
</html>
