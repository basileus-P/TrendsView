<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Breakthrough — Stocks + Google Trends + Radar</title>
<style>
  :root{--bg:#0b0f14;--panel:#111826;--border:#1c2633;--text:#e6eef7;--muted:#9fb3c8;--good:#19c37d;--bad:#e26d6d;--dim:#6b7c91}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;background:#0a1018;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:18px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar input{background:#0e1522;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}
  .toolbar button{background:#152235;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .toolbar button:hover{filter:brightness(1.1)}
  #last-updated{color:var(--muted);font-size:12px}

  .container{display:flex;flex-direction:column;gap:16px;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
  .card h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600}
  .remove-btn{position:absolute;top:10px;right:10px;background:#1b293d;border:1px solid var(--border);color:#d77;padding:4px 8px;border-radius:8px;font-size:12px;cursor:pointer}
  .remove-btn:hover{filter:brightness(1.1)}

  /* Radar table */
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid var(--border);padding:6px 4px;color:var(--text)}
  th{color:var(--muted);text-align:left}
  td.v{text-align:right}
  td.s{text-align:center}
  .sig{display:inline-block;width:10px;height:10px;border-radius:50%}
  .sig.good{background:var(--good)} .sig.bad{background:var(--bad)} .sig.neu{background:#3b475a}

  /* sparkline */
  .spark{height:32px;width:100%}

  @media(max-width:980px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
  <header>
    <h1>Stocks (left) • Google Trends (middle) • Breakout Radar (right)</h1>
    <div class="toolbar">
      <input id="in-symbol" placeholder="EXCHANGE:TICKER (e.g., NASDAQ:MVIS)" size="26" />
      <input id="in-name" placeholder="Display name" size="18" />
      <input id="in-trend" placeholder="Google Trends term" size="18" />
      <button id="btn-add">Add / Update</button>
      <button id="btn-reset">Reset defaults</button>
      <button id="btn-refresh">Refresh Now</button>
      <span id="last-updated"></span>
    </div>
  </header>

  <div id="grid" class="container"></div>

  <!-- Google Trends embed loader -->
  <script src="https://ssl.gstatic.com/trends_nrtr/3343_RC01/embed_loader.js"></script>
  <script>
    /**********************
     * CONFIG
     **********************/
    const STORAGE_KEY = 'WATCHLIST_BREAKTHROUGH_V3';
    // set any defaults you like here
    const DEFAULT_WATCHLIST = [
      { symbol:"NASDAQ:MVIS", name:"MicroVision (MVIS)", trendTerm:"MicroVision" },
      { symbol:"NASDAQ:QSI",  name:"Quantum-Si (QSI)",   trendTerm:"Quantum-Si" },
      { symbol:"NASDAQ:REKR", name:"Rekor Systems (REKR)", trendTerm:"Rekor Systems" }
    ];

    const TRENDS_GEO  = "";
    const TRENDS_TIME = "today 3-m";
    const BENCHMARK   = "QQQ";      // Relative strength baseline
    const RS_LOOKBACK = 10;         // days
    const AVG_VOL_WIN = 20;
    const HIGH_LOOKBK = 30;
    const MA50_WIN    = 50;
    const MA200_WIN   = 200;

    // thresholds for signal coloring
    const THRESH = {
      volVsAvg: 2.0,          // >= 2x avg volume
      rsOutperf: 0.02,        // >= +2% vs QQQ over lookback
      nearHighPct: -0.05      // within 5% of 30d high
    };

    // refresh cadence
    const AUTO_REFRESH_MS = 5 * 60 * 1000;

    /**********************
     * STORAGE HELPERS
     **********************/
    function getWatchlist(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return DEFAULT_WATCHLIST.slice();
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr) || !arr.length) return DEFAULT_WATCHLIST.slice();
        return arr;
      }catch{ return DEFAULT_WATCHLIST.slice(); }
    }
    function setWatchlist(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch{} }
    function yTicker(sym){ return String(sym||'').split(':').pop().trim().toUpperCase(); }

    /**********************
     * STQQ — ST﻿OOQ FETCHERS (NO CORS ISSUES)
     **********************/
    function stooqSymbol(sym){
      const t = String(sym || '').split(':').pop().trim().toLowerCase();
      return `${t}.us`;
    }
    async function fetchStooqDailyCSV(sym){
      const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(sym)}&i=d`;
      const r = await fetch(url, {mode:'cors'});
      if(!r.ok) throw new Error('stooq fetch failed ('+r.status+')');
      const text = await r.text();
      const lines = text.trim().split('\n');
      if(lines.length<2) throw new Error('stooq empty');
      const hdr = lines.shift().split(',');
      const idx = Object.fromEntries(hdr.map((h,i)=>[h,i]));
      return lines.map(line=>{
        const c = line.split(',');
        return {
          date: c[idx['Date']],
          open: +c[idx['Open']],
          high: +c[idx['High']],
          low:  +c[idx['Low']],
          close:+c[idx['Close']],
          volume:+c[idx['Volume']]
        };
      }).filter(r=>Number.isFinite(r.close)&&Number.isFinite(r.volume));
    }

    /**********************
     * UI: TRADINGVIEW + TRENDS
     **********************/
    function renderTradingView(container, symbol){
      const wrap=document.createElement('div');
      wrap.className='tradingview-widget-container';
      const widget=document.createElement('div');
      widget.className='tradingview-widget-container__widget';
      wrap.appendChild(widget);
      const s=document.createElement('script');
      s.type='text/javascript';
      s.src='https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      s.async=true;
      s.innerHTML=JSON.stringify({
        symbols:[[symbol+"|1D"]],
        chartOnly:false, width:"100%", height:"100%", autosize:true,
        locale:"en", dateRange:"12M", showVolume:true, showMA:true, colorTheme:"dark"
      });
      wrap.style.height='400px';
      container.appendChild(wrap); container.appendChild(s);
    }

    function renderTrends(container, keyword){
      try{
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidgetTo==='function'){
          trends.embed.renderExploreWidgetTo(
            container,
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery:`q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          ); return;
        }
        const src = `https://trends.google.com:443/trends/embed/?q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`;
        const iframe=document.createElement('iframe');
        iframe.src=src; iframe.width='100%'; iframe.height='360'; iframe.frameBorder='0';
        container.appendChild(iframe);
      }catch(e){
        const err=document.createElement('div'); err.style.color='#f99';
        err.textContent='Trends error: '+e.message; container.appendChild(err);
      }
    }

    /**********************
     * SPARKLINE (SVG)
     **********************/
    function renderSparkline(el, arr){
      if(!el || !arr || arr.length<2){ el.innerHTML=''; return; }
      const w = el.clientWidth || 260, h = 32, p=2;
      const min = Math.min(...arr), max = Math.max(...arr), span = (max-min)||1;
      const pts = arr.map((v,i)=>{
        const x = p + (i*(w-2*p))/(arr.length-1);
        const y = h - p - ((v-min)*(h-2*p))/span;
        return [x,y];
      });
      const d = pts.map((p,i)=> (i? 'L':'M')+p[0].toFixed(1)+','+p[1].toFixed(1)).join(' ');
      el.innerHTML = `<svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
        <path d="${d}" fill="none" stroke="#8fb6ff" stroke-width="1.5"/>
      </svg>`;
    }

    /**********************
     * RADAR CALCS (STOOQ DATA)
     **********************/
    function sma(arr,n){ const s=arr.slice(-n); return s.reduce((a,b)=>a+b,0)/Math.max(1,s.length); }

    async function populateRadar(rowIdx, symbol){
      try{
        const sym = stooqSymbol(symbol);
        const bench = stooqSymbol(BENCHMARK);
        const [rows, brow] = await Promise.all([
          fetchStooqDailyCSV(sym),
          fetchStooqDailyCSV(bench)
        ]);

        const closes  = rows.map(r=>r.close);
        const volumes = rows.map(r=>r.volume);
        const price   = closes.at(-1);

        // Sparkline: last 30 closes
        renderSparkline(document.getElementById(`spark-${rowIdx}`), closes.slice(-30));

        // Volume vs 20d avg
        const recentVol = volumes.at(-1);
        const avgVol = volumes.slice(-AVG_VOL_WIN).reduce((a,b)=>a+b,0)/Math.max(1, Math.min(AVG_VOL_WIN, volumes.length));
        const volVs = recentVol / (avgVol || 1);
        setVal(`vavg-${rowIdx}`, volVs.toFixed(2)+'x', volVs>=THRESH.volVsAvg);

        // RS vs QQQ (10d)
        const bc = brow.map(r=>r.close);
        const p0 = closes[Math.max(0, closes.length-1-RS_LOOKBACK)];
        const b0 = bc[Math.max(0, bc.length-1-RS_LOOKBACK)];
        const rs = (price/p0) / (bc.at(-1)/b0) - 1;
        setVal(`rs-${rowIdx}`, (rs*100).toFixed(1)+'%', rs>=THRESH.rsOutperf);

        // Price vs 30d high
        const windowCloses = closes.slice(-HIGH_LOOKBK);
        const high = Math.max(...windowCloses);
        const nearHigh = price/high - 1; // negative below high
        setVal(`phigh-${rowIdx}`, (nearHigh*100).toFixed(1)+'%', nearHigh>=THRESH.nearHighPct);

        // MAs
        const ma50 = sma(closes, MA50_WIN);
        const ma200 = sma(closes, MA200_WIN);
        const above50 = price>ma50, above200 = price>ma200;
        const maTxt = `${above50?'Above':'Below'} 50d / ${above200?'Above':'Below'} 200d`;
        setVal(`ma-${rowIdx}`, maTxt, (above50 && above200));

        // Next earnings (removed: Yahoo off); leave placeholder
        setVal(`earn-${rowIdx}`, '—', null, true);

      }catch(err){
        // set dashes
        ['vavg','rs','phigh','ma','earn'].forEach(k=>{
          const a=document.getElementById(`${k}-${rowIdx}`); if(a) a.textContent='—';
          const s=document.getElementById(`${k}-s-${rowIdx}`); if(s) s.innerHTML='<span class="sig neu"></span>';
        });
        console.error('Radar error', symbol, err);
      }
    }

    function setVal(id, val, good=null, mute=false){
      const vEl = document.getElementById(id); if(vEl){ vEl.textContent = val; if(mute) vEl.style.color='var(--muted)'; }
      const sEl = document.getElementById(id+'-s'); if(sEl){
        if(good===null){ sEl.innerHTML='<span class="sig neu"></span>'; }
        else{ sEl.innerHTML = `<span class="sig ${good?'good':'bad'}"></span>`; }
      }
    }

    /**********************
     * BUILD + RENDER
     **********************/
    const grid = document.getElementById('grid');

    function buildRow(item, idx){
      const row=document.createElement('div'); row.className='row';

      // LEFT: price & chart (TradingView)
      const left=document.createElement('div'); left.className='card';
      const hL=document.createElement('h2'); hL.textContent=`${item.name} — Price`;
      const cL=document.createElement('div'); cL.style.height='400px';
      left.appendChild(hL); left.appendChild(cL);

      // MIDDLE: Google Trends
      const mid=document.createElement('div'); mid.className='card';
      const hM=document.createElement('h2'); hM.textContent=`Google Trends — “${item.trendTerm}” (3m, Worldwide)`;
      const cM=document.createElement('div'); cM.style.height='360px';
      mid.appendChild(hM); mid.appendChild(cM);

      // RIGHT: Radar
      const right=document.createElement('div'); right.className='card';
      const hR=document.createElement('h2'); hR.textContent='Breakout Radar';
      const remove=document.createElement('button'); remove.className='remove-btn'; remove.textContent='Remove';
      remove.addEventListener('click',()=>removeStock(idx));
      const tbl=document.createElement('table');
      tbl.innerHTML = `
        <thead>
          <tr><th>Metric</th><th class="v">Value</th><th class="s">Signal</th></tr>
        </thead>
        <tbody>
          <tr><td>Volume vs 20d Avg</td><td id="vavg-${idx}" class="v">—</td><td id="vavg-${idx}-s" class="s"><span class="sig neu"></span></td></tr>
          <tr><td>RS vs ${BENCHMARK} (${RS_LOOKBACK}d)</td><td id="rs-${idx}" class="v">—</td><td id="rs-${idx}-s" class="s"><span class="sig neu"></span></td></tr>
          <tr><td>Price vs 30d High</td><td id="phigh-${idx}" class="v">—</td><td id="phigh-${idx}-s" class="s"><span class="sig neu"></span></td></tr>
          <tr><td>Above 50d / 200d MA</td><td id="ma-${idx}" class="v">—</td><td id="ma-${idx}-s" class="s"><span class="sig neu"></span></td></tr>
          <tr><td>Next Earnings</td><td id="earn-${idx}" class="v">—</td><td class="s"><span class="sig neu"></span></td></tr>
          <tr><td colspan="3"><div id="spark-${idx}" class="spark"></div></td></tr>
        </tbody>`;
      right.appendChild(hR); right.appendChild(remove); right.appendChild(tbl);

      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      grid.appendChild(row);

      // Embeds + fills
      renderTradingView(cL, item.symbol);
      renderTrends(cM, item.trendTerm);
      populateRadar(idx, item.symbol);
    }

    function renderAll(){
      grid.innerHTML='';
      const list = getWatchlist();
      list.forEach((it,i)=> buildRow(it,i));
      updateTimestamp();
    }

    /**********************
     * WATCHLIST OPS
     **********************/
    function addOrUpdate(){
      const s = document.getElementById('in-symbol').value.trim();
      const n = document.getElementById('in-name').value.trim() || s;
      const t = document.getElementById('in-trend').value.trim() || n;
      if(!s){ alert('Enter symbol in EXCHANGE:TICKER format (e.g., NASDAQ:MVIS)'); return; }
      const key = yTicker(s);
      const list = getWatchlist();
      const i = list.findIndex(x=> yTicker(x.symbol)===key);
      if(i===-1) list.push({symbol:s,name:n,trendTerm:t});
      else       list[i]={symbol:s,name:n,trendTerm:t};
      setWatchlist(list);
      document.getElementById('in-symbol').value='';
      document.getElementById('in-name').value='';
      document.getElementById('in-trend').value='';
      renderAll();
    }
    function removeStock(idx){
      const list = getWatchlist();
      list.splice(idx,1);
      setWatchlist(list);
      renderAll();
    }
    function resetDefaults(){ setWatchlist(DEFAULT_WATCHLIST.slice()); renderAll(); }

    function updateTimestamp(){
      const el=document.getElementById('last-updated');
      if(!el) return;
      el.textContent='Last updated: '+new Date().toLocaleTimeString();
      el.style.color='var(--good)';
      setTimeout(()=>{ el.style.color='var(--muted)'; },1200);
    }

    document.getElementById('btn-add').addEventListener('click', addOrUpdate);
    document.getElementById('btn-reset').addEventListener('click', resetDefaults);
    document.getElementById('btn-refresh').addEventListener('click', renderAll);

    // Initial + periodic refresh
    renderAll();
    setInterval(renderAll, AUTO_REFRESH_MS);
  </script>
</body>
</html>
