<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stocks + Google Trends Dashboard</title>
  <style>
    :root { --bg:#0b0f14; --panel:#111826; --border:#1c2633; --text:#e6eef7; --muted:#9fb3c8; --good:#19c37d; --bad:#d66; --warn:#d6a019; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:16px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar input{background:#0e1522;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}
    .toolbar button{background:#152235;border:1px solid var(--border);color:#e6eef7;padding:8px 12px;border-radius:10px;cursor:pointer}
    .toolbar button:hover{filter:brightness(1.1)}

    .container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:16px;align-items:start}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    .card h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px;padding-right:36px}
    .remove-btn{position:absolute;top:10px;right:10px;background:#1b293d;border:1px solid var(--border);color:#d77;padding:4px 8px;border-radius:8px;font-size:12px;cursor:pointer}
    .remove-btn:hover{filter:brightness(1.1)}

    .chart{height:400px}
    .trend{height:360px}
    table{color:var(--text)} th,td{border-color:var(--border)}
    .val { text-align:right; }
    .sig { text-align:center; width:60px; }
    .ok { color: var(--good); font-weight:600; }
    .ko { color: var(--muted); }
    .warn { color: var(--warn); }
    .spark { height:44px; }
    .spark svg { width:100%; height:44px; display:block; }
    .spark .line { fill:none; stroke:#8fb6ff; stroke-width:2; }
    .spark .fill { fill:rgba(143,182,255,0.12); stroke:none; }
    .spark .axis { stroke:#233046; stroke-width:1; }
    @media (max-width:980px){.container{grid-template-columns:1fr}.chart,.trend{height:300px}}
  </style>
</head>
<body>
  <header>
    <h1>Stocks (left) • Google Trends (middle) • Breakout Radar (right)</h1>
    <div class="toolbar">
      <input id="in-symbol" placeholder="EXCHANGE:TICKER (e.g., NASDAQ:MVIS)" size="28" />
      <input id="in-name" placeholder="Display name" size="20" />
      <input id="in-trend" placeholder="Google Trends term" size="20" />
      <button id="btn-add">Add</button>
      <button id="btn-reset">Reset defaults</button>
    </div>
  </header>

  <div id="grid" class="container"></div>

  <!-- Google Trends embed loader -->
  <script src="https://ssl.gstatic.com/trends_nrtr/3343_RC01/embed_loader.js"></script>
  <script>
    /* =============================
       CONFIG
       ============================= */
    const DEFAULT_WATCHLIST = [
      { symbol: "NASDAQ:MVIS", name: "MicroVision (MVIS)", trendTerm: "MicroVision" },
      { symbol: "NASDAQ:QSI",  name: "Quantum-Si (QSI)",   trendTerm: "Quantum-Si" },
      { symbol: "NASDAQ:REKR", name: "Rekor Systems (REKR)", trendTerm: "Rekor Systems" }
    ];
    const STORAGE_KEY = 'WATCHLIST_V1';
    const TRENDS_GEO = "";            // Worldwide
    const TRENDS_TIME = "today 3-m";  // last 3 months

    // Breakout radar params
    const BENCHMARK = "QQQ";  // for RS calc
    const RS_LOOKBACK = 10;
    const AVG_VOL_WINDOW = 20;
    const HIGH_LOOKBACK = 30;
    const MA50_WINDOW = 50;
    const MA200_WINDOW = 200;

    // thresholds (tune as you like)
    const THRESHOLDS = {
      volVsAvg: 1.5,          // >= 1.5x avg volume
      nearHighPct: -0.10,     // within 10% of 30d high
      rsOutperformance: 0.01  // RS >= +1% vs benchmark
    };

    // auto-refresh (milliseconds)
    const REFRESH_MS = 5 * 60 * 1000; // 5 minutes

    /* =============================
       STORAGE
       ============================= */
    function getWatchlist(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return DEFAULT_WATCHLIST.slice();
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr) || !arr.length) return DEFAULT_WATCHLIST.slice();
        return arr;
      }catch{ return DEFAULT_WATCHLIST.slice(); }
    }
    function setWatchlist(arr){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch{}
    }

    /* =============================
       UI HELPERS
       ============================= */
    const grid = document.getElementById('grid');

    function renderTradingView(container, symbol){
      const wrap=document.createElement('div');
      wrap.className='tradingview-widget-container';
      const widget=document.createElement('div');
      widget.className='tradingview-widget-container__widget';
      wrap.appendChild(widget);
      const s=document.createElement('script');
      s.type='text/javascript';
      s.src='https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      s.async=true;
      s.innerHTML=JSON.stringify({
        symbols:[[symbol+"|1D"]],chartOnly:false,width:"100%",height:"100%",locale:"en",autosize:true,dateRange:"12M",showVolume:true,showMA:true
      });
      wrap.appendChild(s);
      container.appendChild(wrap);
    }

    function renderTrends(container, keyword){
      try{
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidgetTo==='function'){
          trends.embed.renderExploreWidgetTo(
            container,
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery: `q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          ); return;
        }
        const src = `https://trends.google.com:443/trends/embed/?q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`;
        const iframe=document.createElement('iframe');
        iframe.src=src; iframe.width='100%'; iframe.height='100%'; iframe.frameBorder='0';
        container.appendChild(iframe);
      }catch(e){
        const err=document.createElement('div'); err.style.color='#f99'; err.textContent='Trends embed error: '+e.message; container.appendChild(err);
      }
    }

    /* =============================
       CORS-RESILIENT YAHOO FETCHERS
       ============================= */
    async function getRaw(url) {
      const candidates = [
        'https://cors.isomorphic-git.org/' + url,
        'https://corsproxy.io/?' + encodeURIComponent(url),
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
      ];
      const addBuster = u => u + (u.includes('?') ? '&' : '?') + 'noCache=' + Date.now();
      let lastErr;
      for (const prox of candidates) {
        try {
          const r = await fetch(addBuster(prox));
          if (!r.ok) throw new Error('proxy status ' + r.status);
          return await r.text();
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('all proxies failed');
    }
    async function getJSON(url) {
      const txt = await getRaw(url);
      try { return JSON.parse(txt); }
      catch (e) { throw new Error('bad JSON: ' + txt.slice(0,80)); }
    }
    function yTicker(sym){ return String(sym || '').split(':').pop().trim().toUpperCase(); }
    async function yahooChart(ticker, range='1y', interval='1d'){
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=${range}&interval=${interval}&includePrePost=false&events=div%7Csplit`;
      return getJSON(url);
    }
    async function yahooEarnings(ticker){
      const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=calendarEvents`;
      return getJSON(url);
    }

    /* =============================
       MINI SPARKLINE
       ============================= */
    function drawSparkline(el, series){
      // series: numbers (last N closes)
      const W = el.clientWidth || 240, H = 44, P = 2;
      const n = series.length;
      const min = Math.min(...series), max = Math.max(...series);
      const x = i => P + (W-2*P) * (i/(n-1 || 1));
      const y = v => {
        if(max === min) return H/2;
        return H - P - (H-2*P) * ((v - min) / (max - min));
      };
      let d = '';
      series.forEach((v,i)=>{ d += (i? 'L':'M') + x(i) + ',' + y(v); });
      const fill = `${d} L ${x(n-1)},${H-P} L ${x(0)},${H-P} Z`;

      el.innerHTML = `
        <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
          <path class="fill" d="${fill}"></path>
          <path class="line" d="${d}"></path>
          <line class="axis" x1="0" y1="${H-P}" x2="${W}" y2="${H-P}"></line>
        </svg>`;
    }

    /* =============================
       BREAKOUT RADAR (Yahoo)
       ============================= */
    function pctFmt(x){ return (x*100).toFixed(1)+'%'; }
    function setSig(elValue, elSig, passed){
      elSig.textContent = passed ? '✅' : '—';
      elSig.className = 'sig ' + (passed ? 'ok' : 'ko');
      elValue.className = 'val ' + (passed ? 'ok' : 'ko');
    }
    function sma(arr,n){ const seg=arr.slice(-n); return seg.reduce((a,b)=>a+b,0)/Math.max(1,seg.length); }

    async function populateRadar(rowIdx, symbol){
      const t = yTicker(symbol);
      try{
        const [ch, bench] = await Promise.all([
          yahooChart(t, '1y', '1d'),
          yahooChart(BENCHMARK, '6mo', '1d')
        ]);

        const c = ch?.chart?.result?.[0];
        const q = c?.indicators?.quote?.[0];
        const closes  = (q?.close  || []).filter(v => v != null);
        const volumes = (q?.volume || []).filter(v => v != null);
        if (closes.length === 0 || volumes.length === 0) throw new Error('no price/volume');

        // Sparkline (last 30 bars)
        const spark = document.getElementById(`spark-${rowIdx}`);
        if (spark) drawSparkline(spark, closes.slice(-30));

        const price = closes[closes.length-1];

        // Volume vs 20d avg
        const vCell = document.getElementById(`vavg-${rowIdx}`);
        const vSig  = document.getElementById(`vavg-s-${rowIdx}`);
        const recentVol = volumes[volumes.length-1];
        const avgVol = volumes.slice(-AVG_VOL_WINDOW).reduce((a,b)=>a+b,0) / Math.max(1, Math.min(AVG_VOL_WINDOW, volumes.length));
        const volVs = recentVol / (avgVol || 1);
        vCell.textContent = volVs.toFixed(2)+'x';
        setSig(vCell, vSig, volVs >= THRESHOLDS.volVsAvg);

        // RS vs QQQ (10d)
        const rCell = document.getElementById(`rs-${rowIdx}`);
        const rSig  = document.getElementById(`rs-s-${rowIdx}`);
        const bc = bench?.chart?.result?.[0]?.indicators?.quote?.[0]?.close?.filter(v=>v!=null) || [];
        const p0 = closes[Math.max(0, closes.length-1-RS_LOOKBACK)];
        const b0 = bc[Math.max(0, bc.length-1-RS_LOOKBACK)];
        const rs = (price/p0) / ((bc[bc.length-1]||p0)/(b0||bc[0]||1)) - 1;
        rCell.textContent = pctFmt(rs);
        setSig(rCell, rSig, rs >= THRESHOLDS.rsOutperformance);

        // Price vs 30d high
        const hCell = document.getElementById(`phigh-${rowIdx}`);
        const hSig  = document.getElementById(`phigh-s-${rowIdx}`);
        const windowCloses = closes.slice(-HIGH_LOOKBACK);
        const high = Math.max(...windowCloses);
        const nearHigh = price/high - 1;  // negative if below high
        hCell.textContent = pctFmt(nearHigh);
        setSig(hCell, hSig, nearHigh >= THRESHOLDS.nearHighPct);

        // MAs
        const mCell = document.getElementById(`ma-${rowIdx}`);
        const mSig  = document.getElementById(`ma-s-${rowIdx}`);
        const ma50  = sma(closes, MA50_WINDOW);
        const ma200 = sma(closes, MA200_WINDOW);
        const above50 = price>ma50, above200 = price>ma200;
        mCell.textContent = `${above50?'Above':'Below'} 50d / ${above200?'Above':'Below'} 200d`;
        setSig(mCell, mSig, above50 && above200);

        // Earnings (best-effort)
        const eCell = document.getElementById(`earn-${rowIdx}`);
        try{
          const ej = await yahooEarnings(t);
          const raw = ej?.quoteSummary?.result?.[0]?.calendarEvents?.earnings?.earningsDate?.[0]?.raw;
          eCell.textContent = raw ? new Date(raw*1000).toISOString().slice(0,10) : '—';
        }catch{ eCell.textContent = '—'; }

      }catch(err){
        ['vavg','vavg-s','rs','rs-s','phigh','phigh-s','ma','ma-s','earn']
          .forEach(id => { const el=document.getElementById(`${id}-${rowIdx}`); if(el) { el.textContent='—'; el.className = el.className?.replace(/\bok\b/g,'ko'); } });
        console.error('Radar error', t, err);
      }
    }

    /* =============================
       BUILD GRID ROWS
       ============================= */
    function buildRow(item, idx){
      const left=document.createElement('div'); left.className='card';
      const hL=document.createElement('h2'); hL.textContent=`${item.name} — Price & Chart`;
      const cL=document.createElement('div'); cL.className='chart';
      left.appendChild(hL); left.appendChild(cL);

      const mid=document.createElement('div'); mid.className='card';
      const hM=document.createElement('h2'); hM.textContent=`Google Trends — “${item.trendTerm}” (3 months, Worldwide)`;
      const cM=document.createElement('div'); cM.className='trend'; cM.id=`trend-${idx}`;
      mid.appendChild(hM); mid.appendChild(cM);

      const right=document.createElement('div'); right.className='card';
      const hR=document.createElement('h2'); hR.textContent='Breakout Radar';
      const remove=document.createElement('button'); remove.className='remove-btn'; remove.textContent='Remove';
      remove.addEventListener('click',()=>{ removeStock(idx); });
      const tbl=document.createElement('table');
      tbl.style.width='100%'; tbl.style.borderCollapse='collapse'; tbl.style.fontSize='12px';
      tbl.innerHTML = `
        <thead>
          <tr><th>Metric</th><th class="val">Value</th><th class="sig">Signal</th></tr>
        </thead>
        <tbody>
          <tr><td>Volume vs 20d Avg</td><td id="vavg-${idx}" class="val">—</td><td id="vavg-s-${idx}" class="sig">—</td></tr>
          <tr><td>RS vs ${BENCHMARK} (${RS_LOOKBACK}d)</td><td id="rs-${idx}" class="val">—</td><td id="rs-s-${idx}" class="sig">—</td></tr>
          <tr><td>Price vs 30d High</td><td id="phigh-${idx}" class="val">—</td><td id="phigh-s-${idx}" class="sig">—</td></tr>
          <tr><td>Above 50d / 200d MA</td><td id="ma-${idx}" class="val">—</td><td id="ma-s-${idx}" class="sig">—</td></tr>
          <tr><td>Next Earnings</td><td id="earn-${idx}" class="val">—</td><td class="sig">—</td></tr>
          <tr><td>Trend (30 bars)</td><td colspan="2"><div id="spark-${idx}" class="spark"></div></td></tr>
        </tbody>`;
      right.appendChild(hR); right.appendChild(remove); right.appendChild(tbl);

      grid.appendChild(left); grid.appendChild(mid); grid.appendChild(right);

      renderTradingView(cL, item.symbol);
      renderTrends(cM, item.trendTerm);
      populateRadar(idx, item.symbol);
    }

    function renderAll(){
      grid.innerHTML='';
      getWatchlist().forEach((it, i)=> buildRow(it, i));
    }
    function addStock(){
      const s = document.getElementById('in-symbol').value.trim();
      const n = document.getElementById('in-name').value.trim() || s;
      const t = document.getElementById('in-trend').value.trim() || n;
      if(!s){ alert('Enter symbol in EXCHANGE:TICKER format (e.g., NASDAQ:MVIS)'); return; }
      const list = getWatchlist(); list.push({ symbol:s, name:n, trendTerm:t }); setWatchlist(list); renderAll();
      document.getElementById('in-symbol').value=''; document.getElementById('in-name').value=''; document.getElementById('in-trend').value='';
    }
    function removeStock(idx){
      const list = getWatchlist(); list.splice(idx,1); setWatchlist(list); renderAll();
    }
    function resetDefaults(){ setWatchlist(DEFAULT_WATCHLIST.slice()); renderAll(); }

    document.getElementById('btn-add').addEventListener('click', addStock);
    document.getElementById('btn-reset').addEventListener('click', resetDefaults);

    // Initial render
    renderAll();

    // Auto-refresh the radar every 5 minutes (without re-embedding left/middle)
    setInterval(() => {
      const list = getWatchlist();
      list.forEach((it, i)=> populateRadar(i, it.symbol));
    }, REFRESH_MS);
  </script>
</body>
</html>
