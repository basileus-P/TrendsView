<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VALUE — Intrinsic Tracking</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --border:#1c2633; --text:#e6eef7; --muted:#9fb3c8;
      --good:#19c37d; --bad:#e26d6d; --accent:#8fb6ff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    /* Top tabs (so VALUE lives alongside INDEX/SCREENERS/SETTINGS) */
    .tabs{display:flex;gap:8px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#0a1018;position:sticky;top:0;z-index:5}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1826;color:var(--muted);text-decoration:none}
    .tab.active{background:#172335;color:#fff;border-color:#223146}
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar input{background:#0e1522;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}
    .toolbar button{background:#152235;border:1px solid var(--border);color:#e6eef7;padding:8px 12px;border-radius:10px;cursor:pointer}
    .toolbar button:hover{filter:brightness(1.1)}
    #last-updated{color:var(--muted);font-size:12px}

    .container{display:flex;flex-direction:column;gap:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    .card h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600}
    .price-tile{display:flex;align-items:baseline;gap:10px}
    .price-tile .big{font-size:24px;font-weight:700}
    .price-tile .chg{font-size:12px}
    .chg.up{color:var(--good)} .chg.down{color:var(--bad)}

    .val-table{width:100%;border-collapse:collapse;margin-top:6px}
    .val-table td{padding:4px 0;border-color:var(--border)}
    .val-kv{display:flex;justify-content:space-between;gap:12px}
    .val-up{font-weight:700}
    .up{color:var(--good)} .down{color:var(--bad)}

    .news{margin-top:10px}
    .news h3{margin:10px 0 6px;font-size:12px;color:var(--muted)}
    .news ul{list-style:none;margin:0;padding:0}
    .news li{margin:6px 0}
    .news a{color:var(--accent);text-decoration:none}
    .news a:hover{text-decoration:underline}
    .news time{color:var(--muted);font-size:11px;margin-left:6px}

    .remove-btn{position:absolute;top:10px;right:10px;background:#1b293d;border:1px solid var(--border);color:#d77;padding:4px 8px;border-radius:8px;font-size:12px;cursor:pointer}
    .remove-btn:hover{filter:brightness(1.1)}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav class="tabs">
    <a class="tab" href="index.html">INDEX</a>
    <a class="tab" href="screeners.html">SCREENERS</a>
    <a class="tab" href="settings.html">SETTINGS</a>
    <span class="tab active">VALUE</span>
  </nav>

  <header>
    <h1>VALUE — Current Price • Google Trends (1m) • Intrinsic Valuation + News</h1>
    <div class="toolbar">
      <input id="in-symbol" placeholder="EXCHANGE:TICKER (e.g., NASDAQ:NU)" size="28" />
      <input id="in-name" placeholder="Display name" size="20" />
      <input id="in-trend" placeholder="Google Trends term" size="18" />
      <button id="btn-add">Add / Update</button>
      <button id="btn-reset">Reset defaults</button>
      <button id="btn-refresh">Refresh Now</button>
      <span id="last-updated"></span>
    </div>
  </header>

  <div id="grid" class="container"></div>

  <!-- Google Trends embed loader -->
  <script src="https://ssl.gstatic.com/trends_nrtr/3343_RC01/embed_loader.js"></script>
  <script>
    /* ===============================
       CONFIG
       =============================== */
    const STORAGE_KEY = 'VALUE_WATCHLIST_V1';
    const DEFAULT_WATCHLIST = [
      { symbol: "NYSE:NU",  name: "Nu Holdings (NU)",     trendTerm: "Nubank" },
      { symbol: "NASDAQ:OPEN", name: "Opendoor (OPEN)",   trendTerm: "Opendoor" },
      { symbol: "NASDAQ:APLD", name: "Applied Digital",   trendTerm: "Applied Digital" }
    ];
    const TRENDS_GEO  = "";            // worldwide
    const TRENDS_TIME = "today 1-m";   // last 1 month

    // Valuation constants (conservative defaults; can be made configurable later)
    const TAX_RATE = 0.25;
    const R_DEFAULT = 0.11;    // required return baseline; we’ll adjust by size if needed
    const G1_MAX = 0.08;       // FCF growth cap in perpetuity leg (safety)
    const G0_TERM = 0.02;      // terminal growth
    const REFRESH_MS_VAL = 10 * 60 * 1000; // fundamentals/news refresh every 10m

    /* ===============================
       STORAGE
       =============================== */
    function getWatchlist(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return DEFAULT_WATCHLIST.slice();
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr) || !arr.length) return DEFAULT_WATCHLIST.slice();
        return arr;
      }catch{ return DEFAULT_WATCHLIST.slice(); }
    }
    function setWatchlist(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch{} }
    function yTicker(sym){ return String(sym || '').split(':').pop().trim().toUpperCase(); }
    function rowIdFromSymbol(symbol){ return 'row-' + yTicker(symbol).replace(/[^A-Z0-9_-]/g,''); }
    function cid(rid, key){ return `${key}-${rid}`; }

    /* ===============================
       RESILIENT FETCHING (CORS-safe)
       =============================== */
    async function getRaw(url) {
      const proxies = [
        'https://cors.isomorphic-git.org/' + url,
        'https://corsproxy.io/?' + encodeURIComponent(url),
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
      ];
      const addBuster = u => u + (u.includes('?') ? '&' : '?') + 'noCache=' + Date.now();
      let lastErr;
      for (const p of proxies) {
        try {
          const r = await fetch(addBuster(p));
          if (!r.ok) throw new Error('status '+r.status);
          return await r.text();
        } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('all proxies failed');
    }
    async function getJSON(url){
      const txt = await getRaw(url);
      try { return JSON.parse(txt); }
      catch(e){ throw new Error('bad JSON: '+txt.slice(0,140)); }
    }

    /* ===============================
       YAHOO FUNDAMENTALS
       =============================== */
    async function fetchYahooQuoteSummary(ticker){
      // Pull many modules at once; Yahoo returns only those available
      const modules = [
        'price','financialData','defaultKeyStatistics',
        'incomeStatementHistoryQuarterly','cashflowStatementHistory',
        'balanceSheetHistory'
      ].join(',');
      const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=${modules}`;
      return getJSON(url);
    }

    function num(raw){ return (raw && typeof raw.raw==='number') ? raw.raw : null; }

    function sumRaw(arr, key, n){
      if(!Array.isArray(arr)) return null;
      let s=0, c=0;
      for (let i=0;i<Math.min(n, arr.length);i++){
        const v = num(arr[i]?.[key]);
        if(typeof v==='number'){ s+=v; c++; }
      }
      return c ? s : null;
    }

    async function getFundamentals(ticker){
      // returns { price, change, revenueTTM, opIncTTM, fcfTTM, cash, debt, sharesOut, netCash }
      const j = await fetchYahooQuoteSummary(ticker);
      const res = j?.quoteSummary?.result?.[0] || {};

      const price = num(res.price?.regularMarketPrice);
      const change = num(res.price?.regularMarketChangePercent); // % change
      const sharesOut = num(res.defaultKeyStatistics?.sharesOutstanding)
                     || num(res.price?.sharesOutstanding);

      // Revenue TTM from quarterly income statements (sum last 4)
      const incQ = res.incomeStatementHistoryQuarterly?.incomeStatementHistory || [];
      const revenueTTM = sumRaw(incQ, 'totalRevenue', 4);
      const opIncTTM   = sumRaw(incQ, 'operatingIncome', 4);

      // FCF TTM — prefer cashflowStatementHistory (annual TTM-ish best effort)
      const cf = res.cashflowStatementHistory?.cashflowStatements || [];
      const fcfTTM = num(cf[0]?.freeCashFlow) ?? num(res.financialData?.freeCashflow);

      // Cash & Debt
      const fin = res.financialData || {};
      let cash = num(fin.totalCash) ?? null;
      let debt = num(fin.totalDebt) ?? null;

      // If financialData missing, try balance sheet last statement
      const bs = res.balanceSheetHistory?.balanceSheetStatements || [];
      if (cash==null) cash = num(bs[0]?.cash) ?? num(bs[0]?.cashAndCashEquivalents);
      if (debt==null) debt = num(bs[0]?.shortLongTermDebtTotal) ?? num(bs[0]?.longTermDebt);

      const netCash = (typeof cash==='number' ? cash : 0) - (typeof debt==='number' ? debt : 0);

      return { price, change, revenueTTM, opIncTTM, fcfTTM, cash, debt, netCash, sharesOut };
    }

    /* ===============================
       VALUATION (HIV)
       =============================== */
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

    function chooseR(sharesOut){
      // crude size-based risk: smaller float -> higher r
      if(!sharesOut) return R_DEFAULT;
      if (sharesOut > 2e9) return 0.10;
      if (sharesOut > 5e8) return 0.105;
      if (sharesOut > 1e8) return 0.11;
      return 0.12;
    }

    function computeHIV(f){
      // Guard
      if(!f || !f.price || !f.sharesOut || !f.revenueTTM){ return null; }

      const r = chooseR(f.sharesOut);
      // Operating margin (normalized)
      const om = (f.opIncTTM && f.revenueTTM) ? clamp(f.opIncTTM / f.revenueTTM, -0.2, 0.4) : 0;
      const omNorm = Math.max(0, Math.min(0.18, om)); // cap at 18% for conservatism

      // 1) FCF leg
      let wFCF = 0.6, wEPV = 0.3, wSales = 0.1;
      let Vfcf = 0;
      if (typeof f.fcfTTM === 'number' && f.fcfTTM > 0){
        const g1 = 0.04; // conservative growth if we can't compute
        const g = Math.min(G1_MAX, Math.max(0.0, g1));
        Vfcf = f.fcfTTM * (1 + g) / Math.max(0.0001, (r - g));
      } else {
        wFCF = 0.0; wEPV = 0.4; wSales = 0.6;
      }

      // 2) Earnings Power Value (EPV) using normalized margin
      const nopat = (f.revenueTTM * omNorm) * (1 - TAX_RATE);
      const Vepv = nopat / Math.max(0.0001, r);

      // 3) Sales-based leg (for transition names)
      const targetMargin = Math.max(0.05, omNorm * 0.7); // a haircut; min 5%
      const Vsales = (f.revenueTTM * targetMargin * (1 - TAX_RATE)) / Math.max(0.0001, (r - G0_TERM));

      // 4) Net Cash
      const netCashAdj = (typeof f.netCash==='number') ? f.netCash : 0;

      const enterpriseVal = (wFCF * Vfcf) + (wEPV * Vepv) + (wSales * Vsales);
      const equityVal = enterpriseVal + netCashAdj;

      const fairPerShare = equityVal / f.sharesOut;
      const gap = (fairPerShare - f.price) / f.price; // positive = undervalued

      return {
        fair: fairPerShare,
        gap, // fraction
        parts: { Vfcf, Vepv, Vsales, netCashAdj, wFCF, wEPV, wSales, r, omNorm }
      };
    }

    /* ===============================
       NEWS (Google News RSS)
       =============================== */
    function relTime(d){
      const t = new Date(d).getTime(); if(!isFinite(t)) return '';
      const mins = Math.max(1, Math.round((Date.now() - t)/60000));
      if (mins < 60) return `${mins}m`; const hrs = Math.round(mins/60);
      if (hrs < 24) return `${hrs}h`; return `${Math.round(hrs/24)}d`;
    }
    async function fetchNewsItems(query){
      const url = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
      const xmlText = await getRaw(url);
      const doc = new DOMParser().parseFromString(xmlText, "text/xml");
      const items = [...doc.getElementsByTagName('item')].slice(0,3).map(node => {
        const title = node.getElementsByTagName('title')[0]?.textContent || '';
        const link = node.getElementsByTagName('link')[0]?.textContent || '#';
        const pub  = node.getElementsByTagName('pubDate')[0]?.textContent || '';
        const source = node.getElementsByTagName('source')[0]?.textContent || '';
        return { title, link, pub, source };
      });
      return items;
    }
    function renderNewsList(container, items){
      if(!container) return;
      if(!items?.length){
        container.innerHTML = `<div class="news"><h3>Latest News</h3><div style="color:var(--muted)">—</div></div>`;
        return;
      }
      container.innerHTML = `
        <div class="news">
          <h3>Latest News</h3>
          <ul>
            ${items.map(it => `
              <li>
                <a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.title}</a>
                ${it.source ? ` <span style="color:var(--muted);font-size:11px">(${it.source})</span>` : ''}
                ${it.pub ? `<time>· ${relTime(it.pub)}</time>` : ''}
              </li>
            `).join('')}
          </ul>
        </div>`;
    }

    /* ===============================
       GOOGLE TRENDS (1 month)
       =============================== */
    function renderTrends(container, keyword){
      try{
        if (window.trends && trends.embed && typeof trends.embed.renderExploreWidgetTo==='function'){
          trends.embed.renderExploreWidgetTo(
            container,
            'TIMESERIES',
            { comparisonItem:[{ keyword, geo:TRENDS_GEO, time:TRENDS_TIME }], category:0, property:'' },
            { exploreQuery:`q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`, guestPath:'https://trends.google.com:443/trends/embed/' }
          ); return;
        }
        const src = `https://trends.google.com:443/trends/embed/?q=${encodeURIComponent(keyword)}&geo=${TRENDS_GEO}&date=${encodeURIComponent(TRENDS_TIME)}`;
        const iframe=document.createElement('iframe');
        iframe.src=src; iframe.width='100%'; iframe.height='260'; iframe.frameBorder='0';
        container.appendChild(iframe);
      }catch(e){
        const err=document.createElement('div'); err.style.color='#f99'; err.textContent='Trends embed error: '+e.message; container.appendChild(err);
      }
    }

    /* ===============================
       PRICE TILE (Yahoo price)
       =============================== */
    async function fetchYahooPriceOnly(ticker){
      const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(ticker)}`;
      const j = await getJSON(url);
      const q = j?.quoteResponse?.result?.[0] || {};
      return {
        price: typeof q.regularMarketPrice==='number' ? q.regularMarketPrice : null,
        changePct: typeof q.regularMarketChangePercent==='number' ? q.regularMarketChangePercent : null,
        currency: q.currency || 'USD',
        shortName: q.shortName || ticker
      };
    }

    /* ===============================
       BUILD ROWS (AND SORT BY GAP)
       =============================== */
    const grid = document.getElementById('grid');

    function buildRowShell(item){
      const rid = rowIdFromSymbol(item.symbol);
      const row = document.createElement('div'); row.className='row'; row.id = rid;

      // Left: Price
      const left = document.createElement('div'); left.className='card';
      left.innerHTML = `
        <h2>${item.name} — Price</h2>
        <div class="price-tile">
          <div class="big" id="${cid(rid,'price')}">—</div>
          <div class="chg" id="${cid(rid,'chg')}"></div>
        </div>
        <div style="height:240px;margin-top:8px;" id="${cid(rid,'tv')}"></div>
      `;

      // Middle: Trends
      const mid = document.createElement('div'); mid.className='card';
      mid.innerHTML = `
        <h2>Google Trends — “${item.trendTerm}” (1m, Worldwide)</h2>
        <div id="${cid(rid,'trends')}" style="height:260px;"></div>
      `;

      // Right: Valuation + News
      const right = document.createElement('div'); right.className='card';
      const remove=document.createElement('button'); remove.className='remove-btn'; remove.textContent='Remove';
      remove.addEventListener('click',()=> removeStockBySymbol(item.symbol));
      right.appendChild(remove);
      right.innerHTML += `
        <h2>Intrinsic Valuation</h2>
        <div class="val-table">
          <div class="val-kv"><span>Fair Value / Share:</span><span id="${cid(rid,'fair')}">—</span></div>
          <div class="val-kv"><span>Current Price:</span><span id="${cid(rid,'cur')}">—</span></div>
          <div class="val-kv val-up"><span>Undervaluation:</span><span id="${cid(rid,'gap')}">—</span></div>
        </div>
        <div class="news" id="${cid(rid,'news')}"></div>
      `;

      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      grid.appendChild(row);

      // Embeds
      renderTrends(document.getElementById(cid(rid,'trends')), item.trendTerm);
      // TradingView: small single-symbol widget
      const tvMount = document.getElementById(cid(rid,'tv'));
      const s=document.createElement('script');
      s.type='text/javascript';
      s.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
      s.async=true;
      s.innerHTML=JSON.stringify({
        symbol: item.symbol, width:"100%", height:"100%", locale:"en", dateRange:"3M", colorTheme:"dark",
        trendLineColor:"#37a6ef", underLineColor:"rgba(55,166,239,0.15)", isTransparent:true
      });
      const wrap = document.createElement('div'); wrap.className='tradingview-widget-container__widget';
      tvMount.appendChild(wrap); tvMount.appendChild(s);
    }

    async function fillRowData(item){
      const rid = rowIdFromSymbol(item.symbol);

      // 1) Price
      try{
        const po = await fetchYahooPriceOnly(yTicker(item.symbol));
        const pEl = document.getElementById(cid(rid,'price'));
        const cEl = document.getElementById(cid(rid,'chg'));
        if (pEl) pEl.textContent = po.price != null ? (po.price.toFixed(2)+' '+po.currency) : '—';
        if (cEl) {
          const sign = (po.changePct||0) >= 0 ? 'up' : 'down';
          cEl.className = 'chg '+sign;
          cEl.textContent = po.changePct != null ? ((po.changePct>0?'+':'')+po.changePct.toFixed(2)+'%') : '';
        }
      }catch(e){ console.error('price error', item.symbol, e); }

      // 2) Fundamentals & Valuation
      try{
        const f = await getFundamentals(yTicker(item.symbol));
        const v = computeHIV(f);
        const fairEl = document.getElementById(cid(rid,'fair'));
        const curEl  = document.getElementById(cid(rid,'cur'));
        const gapEl  = document.getElementById(cid(rid,'gap'));
        if (fairEl && v){
          fairEl.textContent = '$'+v.fair.toFixed(2);
          curEl.textContent  = f.price!=null ? ('$'+f.price.toFixed(2)) : '—';
          const pct = v.gap*100;
          gapEl.textContent  = (pct>=0?'+':'')+pct.toFixed(1)+'%';
          gapEl.className = 'val-up ' + (pct>=0 ? 'up' : 'down');
          // store gap on the row for later sorting
          document.getElementById(rid).dataset.gap = v.gap;
        } else {
          if(fairEl){ fairEl.textContent='—'; }
          if(curEl){ curEl.textContent='—'; }
          if(gapEl){ gapEl.textContent='—'; gapEl.className='val-up'; }
          document.getElementById(rid).dataset.gap = -999; // sinks to bottom
        }
      }catch(e){
        console.error('valuation error', item.symbol, e);
        const fairEl = document.getElementById(cid(rid,'fair'));
        const curEl  = document.getElementById(cid(rid,'cur'));
        const gapEl  = document.getElementById(cid(rid,'gap'));
        if(fairEl) fairEl.textContent='—';
        if(curEl)  curEl.textContent='—';
        if(gapEl){ gapEl.textContent='—'; gapEl.className='val-up'; }
        document.getElementById(rid).dataset.gap = -999;
      }

      // 3) News
      try{
        const q = `${yTicker(item.symbol)} stock OR ${item.name.replace(/\(.*?\)/g,'').trim()} stock`;
        const items = await fetchNewsItems(q);
        renderNewsList(document.getElementById(cid(rid,'news')), items);
      }catch(e){
        console.error('news error', item.symbol, e);
        renderNewsList(document.getElementById(cid(rid,'news')), []);
      }
    }

    function sortRowsByGap(){
      // Sort by undervaluation (largest positive gap first)
      const rows = Array.from(grid.children);
      rows.sort((a,b)=>{
        const ga = parseFloat(a.dataset.gap ?? '-999');
        const gb = parseFloat(b.dataset.gap ?? '-999');
        return (gb - ga); // desc
      });
      rows.forEach(r => grid.appendChild(r));
    }

    /* ===============================
       RENDER / REFRESH
       =============================== */
    function renderAll(){
      grid.innerHTML = '';
      const list = getWatchlist();
      list.forEach(it => buildRowShell(it));
      Promise.all(list.map(it => fillRowData(it)))
        .then(()=> { sortRowsByGap(); updateTimestamp(); })
        .catch(()=> { sortRowsByGap(); updateTimestamp(); });
    }

    function updateTimestamp(){
      const el = document.getElementById('last-updated');
      if(!el) return;
      const ts = new Date().toLocaleTimeString();
      el.textContent = `Last updated: ${ts}`;
      el.style.color = 'var(--good)';
      setTimeout(()=>{ el.style.color='var(--muted)'; }, 1500);
    }

    function addOrUpdateStock(){
      const s = document.getElementById('in-symbol').value.trim();
      const n = document.getElementById('in-name').value.trim() || s;
      const t = document.getElementById('in-trend').value.trim() || n;
      if(!s){ alert('Enter symbol in EXCHANGE:TICKER format (e.g., NASDAQ:NU)'); return; }
      const list = getWatchlist();
      const key = yTicker(s);
      const i = list.findIndex(x => yTicker(x.symbol) === key);
      if (i === -1) list.push({ symbol:s, name:n, trendTerm:t });
      else          list[i] = { symbol:s, name:n, trendTerm:t };
      setWatchlist(list);
      document.getElementById('in-symbol').value='';
      document.getElementById('in-name').value='';
      document.getElementById('in-trend').value='';
      renderAll();
    }

    function removeStockBySymbol(symbol){
      const key = yTicker(symbol);
      const list = getWatchlist().filter(x => yTicker(x.symbol) !== key);
      setWatchlist(list);
      renderAll();
    }

    function resetDefaults(){ setWatchlist(DEFAULT_WATCHLIST.slice()); renderAll(); }

    document.getElementById('btn-add').addEventListener('click', addOrUpdateStock);
    document.getElementById('btn-reset').addEventListener('click', resetDefaults);
    document.getElementById('btn-refresh').addEventListener('click', renderAll);

    // initial render + periodic refresh
    renderAll();
    setInterval(renderAll, REFRESH_MS_VAL);
  </script>
</body>
</html>
